#!/bin/sh
# ==============================================================================
# ITPM App Startup Script
# ==============================================================================
# 此腳本在 Docker 容器啟動時執行，用於：
# 1. 執行 Prisma 資料庫遷移 (migrate deploy)
# 2. 執行基礎種子資料 (如果需要)
# 3. 啟動 Next.js 應用
#
# 這確保每次部署時資料庫結構都是最新的。
# ==============================================================================

set -e  # 遇到錯誤不退出（讓應用程式可以啟動）

echo "================================================"
echo "🚀 ITPM 應用程式啟動"
echo "================================================"
echo ""

# 檢查 DATABASE_URL 環境變數
if [ -z "$DATABASE_URL" ]; then
    echo "⚠️  警告: DATABASE_URL 未設定，跳過資料庫遷移"
else
    echo "✅ DATABASE_URL 已設定"

    # ------------------------------------------------------------------------------
    # Step 1: 執行 Prisma Migration
    # ------------------------------------------------------------------------------
    echo ""
    echo "📦 執行 Prisma 資料庫遷移..."

    cd /app

    # 使用 node 直接呼叫 prisma CLI
    if node node_modules/.pnpm/prisma@5.22.0/node_modules/prisma/build/index.js migrate deploy --schema=packages/db/prisma/schema.prisma 2>&1; then
        echo "✅ 資料庫遷移成功"
    else
        echo "⚠️  資料庫遷移失敗或已是最新狀態（繼續啟動應用）"
    fi
fi

echo ""
echo "================================================"
echo "🌐 啟動 Next.js 應用..."
echo "================================================"

# 啟動 Next.js 應用
exec node apps/web/server.js
