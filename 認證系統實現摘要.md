# èªè­‰ç³»çµ±å¯¦ç¾æ‘˜è¦

## âœ… å®Œæˆç‹€æ…‹

ç°¡åŒ–ç‰ˆèªè­‰ç³»çµ±å·²æˆåŠŸå¯¦ç¾ä¸¦å¯ç«‹å³ä½¿ç”¨!

## ğŸ¯ å¯¦ç¾å…§å®¹

### 1. æ ¸å¿ƒé…ç½®

#### âœ… NextAuth.js é…ç½® (`packages/auth/src/index.ts`)
- Credentials Provider (Email + Password)
- JWT Session ç­–ç•¥ (24å°æ™‚éæœŸ)
- PrismaAdapter æ•´åˆ
- bcrypt å¯†ç¢¼åŠ å¯† (10 salt rounds)
- TypeScript é¡å‹æ“´å±• (Session, User, JWT)
- è‡ªå®šç¾©ç™»å…¥é é¢è·¯ç”±

#### âœ… è³‡æ–™åº«æ›´æ–°
- Prisma Schema: æ·»åŠ  `password` æ¬„ä½åˆ° User æ¨¡å‹ (nullable)
- Migration: `20251002162554_add_user_password`
- æ”¯æŒæœªä¾† Azure AD B2C ç”¨æˆ¶ (å¯†ç¢¼æ¬„ä½ç‚º null)

### 2. API æ•´åˆ

#### âœ… NextAuth API è·¯ç”± (`apps/web/src/app/api/auth/[...nextauth]/route.ts`)
```
è·¯å¾‘: /api/auth/*
- GET /api/auth/session
- POST /api/auth/signin
- POST /api/auth/signout
- GET /api/auth/providers
- GET /api/auth/csrf
```

#### âœ… tRPC Context æ•´åˆ (`packages/api/src/trpc.ts`)
- `getServerSession()` ç²å– NextAuth session
- `protectedProcedure` ä¸­é–“ä»¶ (é©—è­‰ç™»å…¥ç‹€æ…‹)
- Session æ•¸æ“šæ³¨å…¥åˆ° tRPC context

### 3. å‰ç«¯çµ„ä»¶

#### âœ… ç™»å…¥é é¢ (`apps/web/src/app/login/page.tsx`)
- Email/Password ç™»å…¥è¡¨å–®
- éŒ¯èª¤è™•ç†èˆ‡é¡¯ç¤º
- è¼‰å…¥ç‹€æ…‹ç®¡ç†
- Callback URL é‡å®šå‘
- Tailwind CSS æ¨£å¼

#### âœ… Session Provider (`apps/web/src/components/providers/SessionProvider.tsx`)
- åŒ…è£ NextAuth SessionProvider
- å…¨å±€ Session ç‹€æ…‹ç®¡ç†
- æ•´åˆåˆ° Root Layout

#### âœ… Root Layout æ›´æ–° (`apps/web/src/app/layout.tsx`)
```tsx
<SessionProvider>
  <TRPCProvider>
    <ToastProvider>{children}</ToastProvider>
  </TRPCProvider>
</SessionProvider>
```

#### âœ… é¦–é æ›´æ–° (`apps/web/src/app/page.tsx`)
- é¡¯ç¤ºèªè­‰ç‹€æ…‹
- ç”¨æˆ¶ä¿¡æ¯å±•ç¤º (åç¨±, Email, è§’è‰²)
- ç™»å…¥/ç™»å‡ºæŒ‰éˆ•
- ç™»å…¥é é¢é€£çµ

### 4. è·¯ç”±ä¿è­·

#### âœ… Next.js Middleware (`apps/web/src/middleware.ts`)
ä¿è­·çš„è·¯å¾‘:
- `/dashboard/*`
- `/projects/*`
- `/budget-pools/*`
- `/budget-proposals/*`
- `/vendors/*`
- `/purchase-orders/*`
- `/expenses/*`
- `/users/*`

æœªç™»å…¥ç”¨æˆ¶å°‡è‡ªå‹•é‡å®šå‘åˆ° `/login`

### 5. æ¸¬è©¦æ•¸æ“š

#### âœ… Seed Script (`packages/db/prisma/seed.ts`)

**è§’è‰² (Roles):**
- Admin
- ProjectManager
- Supervisor

**æ¸¬è©¦ç”¨æˆ¶:**
| Email | å¯†ç¢¼ | è§’è‰² | åç¨± |
|-------|------|------|------|
| admin@itpm.local | admin123 | Admin | ç³»çµ±ç®¡ç†å“¡ |
| pm@itpm.local | pm123 | ProjectManager | å°ˆæ¡ˆç¶“ç† - å¼µä¸‰ |
| supervisor@itpm.local | supervisor123 | Supervisor | ä¸»ç®¡ - æå›› |

**ç¤ºç¯„æ•¸æ“š:**
- 2 å€‹é ç®—æ±  (2024, 2025)
- 2 å€‹å°ˆæ¡ˆ
- 2 å€‹ä¾›æ‡‰å•†

## ğŸš€ å¦‚ä½•ä½¿ç”¨

### 1. å•Ÿå‹•æœå‹™

```bash
# å•Ÿå‹• PostgreSQL (Docker)
docker-compose up -d postgres

# å•Ÿå‹•é–‹ç™¼æœå‹™å™¨
pnpm dev
```

### 2. è¨ªå•æ‡‰ç”¨

- **é¦–é **: http://localhost:3001
- **ç™»å…¥é é¢**: http://localhost:3001/login
- **å—ä¿è­·é é¢**: http://localhost:3001/dashboard (éœ€ç™»å…¥)

### 3. æ¸¬è©¦ç™»å…¥

ä½¿ç”¨ä»¥ä¸‹ä»»ä¸€å¸³è™Ÿç™»å…¥:
- `admin@itpm.local` / `admin123`
- `pm@itpm.local` / `pm123`
- `supervisor@itpm.local` / `supervisor123`

## ğŸ“¦ å·²å®‰è£å¥—ä»¶

### packages/auth
```json
{
  "dependencies": {
    "next-auth": "^4.24.6",
    "@next-auth/prisma-adapter": "^1.0.7",
    "bcryptjs": "^2.4.3"
  },
  "devDependencies": {
    "@types/bcryptjs": "^2.4.6"
  }
}
```

### apps/web
```json
{
  "dependencies": {
    "@itpm/auth": "workspace:*",
    "next-auth": "^4.24.6"
  }
}
```

### packages/api
```json
{
  "dependencies": {
    "@itpm/auth": "workspace:*",
    "next-auth": "^4.24.6"
  }
}
```

## ğŸ” å®‰å…¨ç‰¹æ€§

1. **å¯†ç¢¼åŠ å¯†**: bcrypt with 10 salt rounds
2. **JWT Session**: å®‰å…¨çš„ token-based session
3. **ç’°å¢ƒè®Šæ•¸**: `NEXTAUTH_SECRET` ç”¨æ–¼ JWT ç°½å
4. **Session éæœŸ**: 24 å°æ™‚è‡ªå‹•ç™»å‡º
5. **è·¯ç”±ä¿è­·**: Middleware è‡ªå‹•é‡å®šå‘æœªæˆæ¬Šè¨ªå•
6. **tRPC ä¿è­·**: `protectedProcedure` é©—è­‰æ‰€æœ‰ API è«‹æ±‚

## ğŸ”„ æœªä¾†å‡ç´šè·¯å¾‘

ç•¶æº–å‚™å¥½ä½¿ç”¨ Azure AD B2C æ™‚:

1. åœ¨ `packages/auth/src/index.ts` æ·»åŠ  AzureADB2CProvider
2. é…ç½® Azure AD B2C ç’°å¢ƒè®Šæ•¸
3. User.password æ¬„ä½å·²è¨­ç‚º nullable,æ”¯æŒ SSO ç”¨æˆ¶
4. ç„¡éœ€æ›´æ”¹ç¾æœ‰èªè­‰æµç¨‹

## ğŸ“ ç’°å¢ƒè®Šæ•¸

`.env` æ–‡ä»¶å·²é…ç½®:
```env
# Database
DATABASE_URL="postgresql://postgres:localdev123@localhost:5434/itpm_dev"

# NextAuth
NEXTAUTH_SECRET="GN29FTOogkrnhekm/744zMLQ2ulykQey98eXUMnltnA="
NEXTAUTH_URL="http://localhost:3001"
NEXTAUTH_SESSION_MAX_AGE=86400
```

## âœ¨ ä¸‹ä¸€æ­¥

èªè­‰ç³»çµ±å·²å®Œæˆ!ç¾åœ¨å¯ä»¥:

1. âœ… é–‹å§‹é–‹ç™¼éœ€è¦èªè­‰çš„åŠŸèƒ½
2. âœ… ä½¿ç”¨ `protectedProcedure` ä¿è­· tRPC API
3. âœ… è¨ªå• `ctx.session.user` ç²å–ç•¶å‰ç”¨æˆ¶
4. âœ… åŸºæ–¼ `session.user.role` å¯¦ç¾æ¬Šé™æ§åˆ¶

## ğŸ‰ å®Œæˆæ™‚é–“

2025-10-03 00:35 (æœ¬åœ°æ™‚é–“)

---

**ç°¡åŒ–ç‰ˆèªè­‰ç³»çµ±å¯¦ç¾å®Œç•¢!** ğŸš€
