#!/bin/sh
# ==============================================================================
# Prisma Migration + Seed Script
# ==============================================================================
# æ­¤è…³æœ¬åœ¨ Docker å®¹å™¨ä¸­åŸ·è¡Œï¼Œç”¨æ–¼ï¼š
# 1. ç”Ÿæˆ Prisma Client
# 2. åŸ·è¡Œ Prisma è³‡æ–™åº«é·ç§» (migrate deploy)
# 3. åŸ·è¡ŒåŸºç¤ç¨®å­è³‡æ–™ (seed-minimal.ts)
#
# ç’°å¢ƒè®Šæ•¸è¦æ±‚ï¼š
#   - DATABASE_URL: PostgreSQL é€£ç·šå­—ä¸²
# ==============================================================================

set -e  # é‡åˆ°éŒ¯èª¤ç«‹å³é€€å‡º

echo "================================================"
echo "ğŸš€ é–‹å§‹è³‡æ–™åº«é·ç§»å’Œç¨®å­è³‡æ–™æµç¨‹"
echo "================================================"
echo ""

# æª¢æŸ¥ DATABASE_URL ç’°å¢ƒè®Šæ•¸
if [ -z "$DATABASE_URL" ]; then
    echo "âŒ éŒ¯èª¤: DATABASE_URL ç’°å¢ƒè®Šæ•¸æœªè¨­å®š"
    exit 1
fi

echo "âœ… DATABASE_URL å·²è¨­å®š"
echo ""

cd /app/packages/db

# ------------------------------------------------------------------------------
# Step 0: ç”Ÿæˆ Prisma Client
# ------------------------------------------------------------------------------
echo "================================================"
echo "âš™ï¸  Step 0/3: ç”Ÿæˆ Prisma Client"
echo "================================================"

# è¨­å®šç’°å¢ƒè®Šæ•¸ä»¥è·³é SSL é©—è­‰ï¼ˆåƒ…é™é–‹ç™¼ç’°å¢ƒçš„ Prisma å¼•æ“ä¸‹è¼‰ï¼‰
export NODE_TLS_REJECT_UNAUTHORIZED=0

echo "åŸ·è¡Œ: prisma generate"
prisma generate

if [ $? -eq 0 ]; then
    echo "âœ… Prisma Client ç”ŸæˆæˆåŠŸ"
else
    echo "âŒ Prisma Client ç”Ÿæˆå¤±æ•—"
    exit 1
fi

# æ¢å¾© SSL é©—è­‰
export NODE_TLS_REJECT_UNAUTHORIZED=1

echo ""

# ------------------------------------------------------------------------------
# Step 1: åŸ·è¡Œ Prisma Migration
# ------------------------------------------------------------------------------
echo "================================================"
echo "ğŸ“¦ Step 1/3: åŸ·è¡Œ Prisma è³‡æ–™åº«é·ç§»"
echo "================================================"

echo "åŸ·è¡Œ: prisma migrate deploy"
prisma migrate deploy

if [ $? -eq 0 ]; then
    echo "âœ… è³‡æ–™åº«é·ç§»æˆåŠŸ"
else
    echo "âŒ è³‡æ–™åº«é·ç§»å¤±æ•—"
    exit 1
fi

echo ""

# ------------------------------------------------------------------------------
# Step 2: åŸ·è¡Œ Seed è…³æœ¬
# ------------------------------------------------------------------------------
echo "================================================"
echo "ğŸŒ± Step 2/3: åŸ·è¡ŒåŸºç¤ç¨®å­è³‡æ–™"
echo "================================================"

echo "åŸ·è¡Œ: tsx prisma/seed-minimal.ts"
tsx prisma/seed-minimal.ts

if [ $? -eq 0 ]; then
    echo "âœ… ç¨®å­è³‡æ–™åŸ·è¡ŒæˆåŠŸ"
else
    echo "âŒ ç¨®å­è³‡æ–™åŸ·è¡Œå¤±æ•—"
    exit 1
fi

echo ""

# ------------------------------------------------------------------------------
# å®Œæˆ
# ------------------------------------------------------------------------------
echo "================================================"
echo "âœ… è³‡æ–™åº«é·ç§»å’Œç¨®å­è³‡æ–™æµç¨‹å®Œæˆï¼"
echo "================================================"
echo ""
echo "å·²å®Œæˆçš„æ“ä½œï¼š"
echo "  âœ… Prisma Client ç”Ÿæˆ"
echo "  âœ… Prisma migrate deployï¼ˆè¡¨çµæ§‹æ›´æ–°ï¼‰"
echo "  âœ… Seed minimalï¼ˆåŸºç¤è³‡æ–™ï¼šRole, Currencyï¼‰"
echo ""
