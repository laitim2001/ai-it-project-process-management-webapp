name: Deploy to Azure (Staging)

# ðŸŽ¯ è§¸ç™¼æ¢ä»¶ï¼šPush åˆ° main åˆ†æ”¯
on:
  push:
    branches:
      - main
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼

# ç’°å¢ƒè®Šæ•¸
env:
  ENVIRONMENT: staging
  NODE_VERSION: '20.11.0'
  PNPM_VERSION: '8.15.3'

jobs:
  # ============================================================================
  # Job 1: æ¸¬è©¦èˆ‡è³ªé‡æª¢æŸ¥
  # ============================================================================
  test-and-lint:
    name: Test & Lint
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸ—‚ï¸ Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: ðŸ’¾ Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ”¨ Generate Prisma Client
        run: pnpm db:generate

      - name: ðŸ§ª Run type check
        run: pnpm typecheck

      - name: ðŸ§¹ Run lint
        run: pnpm lint

      - name: âœ… Run tests
        run: pnpm test
        env:
          CI: true

  # ============================================================================
  # Job 2: æ§‹å»ºä¸¦éƒ¨ç½²åˆ° Azure Staging ç’°å¢ƒ
  # ============================================================================
  build-and-deploy:
    name: Build & Deploy to Staging
    runs-on: ubuntu-latest
    needs: test-and-lint # æ¸¬è©¦é€šéŽå¾Œæ‰åŸ·è¡Œ

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_STAGING }}

      - name: ðŸ³ Login to Azure Container Registry
        uses: azure/docker-login@v1
        with:
          login-server: ${{ secrets.ACR_REGISTRY_STAGING }}
          username: ${{ secrets.ACR_USERNAME_STAGING }}
          password: ${{ secrets.ACR_PASSWORD_STAGING }}

      - name: ðŸ”¨ Build Docker image
        run: |
          docker build \
            -f docker/Dockerfile \
            -t ${{ secrets.ACR_REGISTRY_STAGING }}/itpm-web:${{ github.sha }} \
            -t ${{ secrets.ACR_REGISTRY_STAGING }}/itpm-web:latest \
            --build-arg NODE_ENV=production \
            .

      - name: â¬†ï¸ Push Docker image to ACR
        run: |
          docker push ${{ secrets.ACR_REGISTRY_STAGING }}/itpm-web:${{ github.sha }}
          docker push ${{ secrets.ACR_REGISTRY_STAGING }}/itpm-web:latest

      - name: ðŸš€ Deploy to Azure App Service (Staging Slot)
        uses: azure/webapps-deploy@v2
        with:
          app-name: app-itpm-staging-001
          slot-name: staging # éƒ¨ç½²åˆ° staging æ§½ä½
          images: ${{ secrets.ACR_REGISTRY_STAGING }}/itpm-web:${{ github.sha }}

      - name: â³ Wait for deployment to complete
        run: sleep 60

      - name: ðŸ¥ Health check (Staging Slot)
        run: |
          APP_URL="https://app-itpm-staging-001-staging.azurewebsites.net"
          MAX_RETRIES=12
          RETRY_COUNT=0

          echo "ðŸ” Checking health of staging slot: $APP_URL"

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$APP_URL" || echo "000")

            if [ "$HTTP_STATUS" == "200" ] || [ "$HTTP_STATUS" == "302" ]; then
              echo "âœ… Staging slot is healthy! (HTTP $HTTP_STATUS)"
              exit 0
            fi

            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "â³ Waiting... ($RETRY_COUNT/$MAX_RETRIES) HTTP: $HTTP_STATUS"
            sleep 10
          done

          echo "âŒ Health check failed after $MAX_RETRIES retries"
          exit 1

      - name: ðŸ”„ Swap staging slot to production
        run: |
          echo "ðŸ”„ Swapping staging slot to production..."
          az webapp deployment slot swap \
            --name app-itpm-staging-001 \
            --resource-group rg-itpm-staging \
            --slot staging \
            --target-slot production

      - name: â³ Wait for swap to complete
        run: sleep 30

      - name: ðŸ¥ Health check (Production Slot)
        run: |
          APP_URL="https://app-itpm-staging-001.azurewebsites.net"
          MAX_RETRIES=12
          RETRY_COUNT=0

          echo "ðŸ” Checking health of production slot: $APP_URL"

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$APP_URL" || echo "000")

            if [ "$HTTP_STATUS" == "200" ] || [ "$HTTP_STATUS" == "302" ]; then
              echo "âœ… Production slot is healthy! (HTTP $HTTP_STATUS)"
              exit 0
            fi

            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "â³ Waiting... ($RETRY_COUNT/$MAX_RETRIES) HTTP: $HTTP_STATUS"
            sleep 10
          done

          echo "âŒ Health check failed after $MAX_RETRIES retries"
          echo "âš ï¸ Consider manual rollback using slot swap"
          exit 1

      - name: ðŸ“‹ Get deployment logs
        if: failure()
        run: |
          echo "=== Production Slot Logs ==="
          az webapp log tail \
            --name app-itpm-staging-001 \
            --resource-group rg-itpm-staging \
            --limit 50

          echo ""
          echo "=== Staging Slot Logs ==="
          az webapp log tail \
            --name app-itpm-staging-001 \
            --resource-group rg-itpm-staging \
            --slot staging \
            --limit 50

  # ============================================================================
  # Job 3: éƒ¨ç½²å¾Œé€šçŸ¥
  # ============================================================================
  notify:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: always() # ç¸½æ˜¯åŸ·è¡Œï¼Œå³ä½¿éƒ¨ç½²å¤±æ•—

    steps:
      - name: ðŸ“¢ Deployment Summary
        run: |
          echo "## ðŸš€ Staging Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: Staging" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**App URL**: https://app-itpm-staging-001.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
          echo "**Staging Slot URL**: https://app-itpm-staging-001-staging.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.build-and-deploy.result }}" == "success" ]; then
            echo "âœ… **Deployment successful!** Slot swap completed." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Deployment failed!** Consider rollback." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ”„ Rollback Command" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "az webapp deployment slot swap \\" >> $GITHUB_STEP_SUMMARY
            echo "  --name app-itpm-staging-001 \\" >> $GITHUB_STEP_SUMMARY
            echo "  --resource-group rg-itpm-staging \\" >> $GITHUB_STEP_SUMMARY
            echo "  --slot staging \\" >> $GITHUB_STEP_SUMMARY
            echo "  --target-slot production" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
