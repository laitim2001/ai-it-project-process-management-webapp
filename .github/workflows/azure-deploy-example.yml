# ============================================================================
# Azure Deployment Workflow - Example Configuration
# ============================================================================
# æ­¤ç‚ºç¯„ä¾‹é…ç½®,å±•ç¤ºå¦‚ä½•åœ¨ CI/CD pipeline ä¸­æ•´åˆ seed data åŸ·è¡Œ
# å¯¦éš›ä½¿ç”¨æ™‚è«‹æ ¹æ“šå°ˆæ¡ˆéœ€æ±‚èª¿æ•´
#
# è§¸ç™¼æ¢ä»¶:
#   - Push åˆ° main åˆ†æ”¯
#   - æ‰‹å‹•è§¸ç™¼ (workflow_dispatch)
#
# é‡è¦æ­¥é©Ÿ:
#   1. Build Docker image
#   2. Push to ACR
#   3. Run database migrations
#   4. â­ Run seed data (é—œéµæ­¥é©Ÿ - é˜²æ­¢ Registration API 500 éŒ¯èª¤)
#   5. Deploy to Azure App Service
#   6. Verify deployment
# ============================================================================

name: Azure Deployment (Example)

on:
  # è‡ªå‹•è§¸ç™¼: Push åˆ° main åˆ†æ”¯
  push:
    branches:
      - main
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - 'claudedocs/**'

  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        type: choice
        options:
          - dev
          - uat
          - production
        default: 'dev'

# ç’°å¢ƒè®Šæ•¸
env:
  AZURE_RESOURCE_GROUP: rg-itpm-dev
  AZURE_APP_SERVICE: app-itpm-dev-001
  AZURE_CONTAINER_REGISTRY: acritpmdev
  DOCKER_IMAGE_NAME: itpm-web
  NODE_VERSION: '20.11.0'

jobs:
  # ========================================
  # Job 1: Build and Test
  # ========================================
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.3

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm db:generate

      - name: Run type check
        run: pnpm typecheck

      - name: Run linting
        run: pnpm lint

      - name: Run tests
        run: pnpm test

  # ========================================
  # Job 2: Build and Push Docker Image
  # ========================================
  build-docker:
    name: Build and Push Docker Image
    needs: build-and-test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure Container Registry
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build Docker image
        run: |
          docker build \
            -t ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.DOCKER_IMAGE_NAME }}:latest \
            -t ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }} \
            -f docker/Dockerfile .

      - name: Push Docker image
        run: |
          docker push ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.DOCKER_IMAGE_NAME }}:latest
          docker push ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}

  # ========================================
  # Job 3: Database Migration and Seed
  # ========================================
  database-setup:
    name: Database Migration and Seed
    needs: build-docker
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.3

      - name: Install dependencies
        run: |
          pnpm install --frozen-lockfile
          pnpm db:generate

      # ========================================
      # Step 3.1: Run Migrations
      # ========================================
      - name: Run database migrations
        env:
          DATABASE_URL: ${{ secrets.AZURE_DATABASE_URL }}
        run: |
          echo "ğŸ”„ Running database migrations..."
          pnpm --filter db prisma migrate deploy
          echo "âœ… Migrations completed"

      # ========================================
      # Step 3.2: â­ Run Seed Data (é—œéµæ­¥é©Ÿ!)
      # ========================================
      # æ­¤æ­¥é©Ÿç¢ºä¿ Role å’Œ Currency åŸºç¤è³‡æ–™å­˜åœ¨
      # é˜²æ­¢ Registration API è¿”å› 500 éŒ¯èª¤ (P2003 å¤–éµç´„æŸéŒ¯èª¤)
      - name: â­ Run minimal seed data
        env:
          DATABASE_URL: ${{ secrets.AZURE_DATABASE_URL }}
        run: |
          echo "ğŸŒ± Running minimal seed data..."
          pnpm db:seed:minimal
          echo "âœ… Seed data completed"

      # ========================================
      # Step 3.3: Verify Seed Data
      # ========================================
      - name: Verify seed data
        env:
          DATABASE_URL: ${{ secrets.AZURE_DATABASE_URL }}
        run: |
          echo "ğŸ” Verifying seed data..."

          # å®‰è£ PostgreSQL client
          sudo apt-get update
          sudo apt-get install -y postgresql-client

          # å¾ DATABASE_URL æå–é€£æ¥åƒæ•¸
          DB_HOST=$(echo $DATABASE_URL | sed -n 's/.*@\(.*\):.*/\1/p')
          DB_NAME=$(echo $DATABASE_URL | sed -n 's/.*\/\(.*\)?.*/\1/p' | cut -d'?' -f1)
          DB_USER=$(echo $DATABASE_URL | sed -n 's/.*:\/\/\(.*\):.*/\1/p')
          DB_PASS=$(echo $DATABASE_URL | sed -n 's/.*:\/\/.*:\(.*\)@.*/\1/p')

          # é©—è­‰ Role è¡¨
          ROLE_COUNT=$(PGPASSWORD=$DB_PASS psql -h $DB_HOST -U $DB_USER -d $DB_NAME -t -c "SELECT COUNT(*) FROM \"Role\";")

          if [ $ROLE_COUNT -ge 3 ]; then
            echo "âœ… Role table verified: $ROLE_COUNT records"
          else
            echo "âŒ Role table verification failed: only $ROLE_COUNT records (expected >= 3)"
            exit 1
          fi

          # é©—è­‰ Currency è¡¨
          CURRENCY_COUNT=$(PGPASSWORD=$DB_PASS psql -h $DB_HOST -U $DB_USER -d $DB_NAME -t -c "SELECT COUNT(*) FROM \"Currency\";")

          if [ $CURRENCY_COUNT -ge 6 ]; then
            echo "âœ… Currency table verified: $CURRENCY_COUNT records"
          else
            echo "âš ï¸  Currency table: $CURRENCY_COUNT records (expected >= 6)"
          fi

          echo "âœ… Seed data verification completed"

  # ========================================
  # Job 4: Deploy to Azure App Service
  # ========================================
  deploy:
    name: Deploy to Azure App Service
    needs: database-setup
    runs-on: ubuntu-latest

    steps:
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure App Service
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ env.AZURE_APP_SERVICE }}
          images: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}

      - name: Restart App Service
        run: |
          az webapp restart \
            --name ${{ env.AZURE_APP_SERVICE }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }}

  # ========================================
  # Job 5: Post-Deployment Verification
  # ========================================
  verify-deployment:
    name: Verify Deployment
    needs: deploy
    runs-on: ubuntu-latest

    steps:
      - name: Wait for service to be ready
        run: |
          echo "â³ Waiting for service to be ready..."
          sleep 30

      - name: Check application health
        run: |
          echo "ğŸ” Checking application health..."

          # å¥åº·æª¢æŸ¥
          STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://${{ env.AZURE_APP_SERVICE }}.azurewebsites.net)

          if [ $STATUS_CODE -eq 200 ]; then
            echo "âœ… Application is healthy (HTTP $STATUS_CODE)"
          else
            echo "âŒ Application health check failed (HTTP $STATUS_CODE)"
            exit 1
          fi

      # ========================================
      # â­ é—œéµæ¸¬è©¦: Registration API é©—è­‰
      # ========================================
      # æ­¤æ¸¬è©¦ç¢ºä¿ Registration API æ­£å¸¸é‹ä½œ
      # å¦‚æœå¤±æ•—,å¯èƒ½è¡¨ç¤º seed data æœªæ­£ç¢ºåŸ·è¡Œ
      - name: â­ Test Registration API
        run: |
          echo "ğŸ§ª Testing Registration API..."

          # ç”Ÿæˆéš¨æ©Ÿ email ä»¥é¿å…è¡çª
          RANDOM_EMAIL="test-$(date +%s)@example.com"

          # æ¸¬è©¦è¨»å†Š API
          RESPONSE=$(curl -s -X POST \
            https://${{ env.AZURE_APP_SERVICE }}.azurewebsites.net/api/auth/register \
            -H "Content-Type: application/json" \
            -d "{
              \"name\": \"CI Test User\",
              \"email\": \"$RANDOM_EMAIL\",
              \"password\": \"TestPassword123\"
            }" \
            -w "\n%{http_code}")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          echo "Response: $BODY"
          echo "HTTP Code: $HTTP_CODE"

          # é©—è­‰å›æ‡‰
          if [ $HTTP_CODE -eq 201 ]; then
            if echo "$BODY" | grep -q '"success":true'; then
              echo "âœ… Registration API test PASSED"
            else
              echo "âŒ Registration API returned unexpected response"
              echo "Response body: $BODY"
              exit 1
            fi
          else
            echo "âŒ Registration API test FAILED (HTTP $HTTP_CODE)"
            echo "Response body: $BODY"

            # å¦‚æœæ˜¯ 500 éŒ¯èª¤,æç¤ºæª¢æŸ¥ seed data
            if [ $HTTP_CODE -eq 500 ]; then
              echo "âš ï¸  500 Error detected - this may indicate missing seed data"
              echo "   Please verify that 'Run minimal seed data' step executed successfully"
            fi

            exit 1
          fi

      - name: Deployment Summary
        if: always()
        run: |
          echo "========================================"
          echo "ğŸš€ Deployment Summary"
          echo "========================================"
          echo "Environment: ${{ github.event.inputs.environment || 'dev' }}"
          echo "Commit: ${{ github.sha }}"
          echo "App Service: ${{ env.AZURE_APP_SERVICE }}"
          echo "Image: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}"
          echo "========================================"

# ============================================================================
# Required GitHub Secrets:
# ============================================================================
# - ACR_USERNAME:          Azure Container Registry ä½¿ç”¨è€…åç¨±
# - ACR_PASSWORD:          Azure Container Registry å¯†ç¢¼
# - AZURE_CREDENTIALS:     Azure Service Principal æ†‘è­‰ (JSON)
# - AZURE_DATABASE_URL:    Azure PostgreSQL é€£æ¥å­—ä¸²
#
# Service Principal æ ¼å¼:
# {
#   "clientId": "xxx",
#   "clientSecret": "xxx",
#   "subscriptionId": "xxx",
#   "tenantId": "xxx"
# }
# ============================================================================

# ============================================================================
# ä½¿ç”¨èªªæ˜:
# ============================================================================
# 1. è¤‡è£½æ­¤æª”æ¡ˆåˆ° .github/workflows/ ç›®éŒ„
# 2. æ ¹æ“šå¯¦éš›æƒ…æ³èª¿æ•´ç’°å¢ƒè®Šæ•¸å’Œé…ç½®
# 3. åœ¨ GitHub Secrets ä¸­è¨­å®šæ‰€éœ€çš„ secrets
# 4. Push åˆ° main åˆ†æ”¯æˆ–æ‰‹å‹•è§¸ç™¼ workflow
# 5. ç›£æ§ workflow åŸ·è¡Œç‹€æ…‹å’Œæ—¥èªŒ
#
# é‡è¦æç¤º:
# - â­ æ¨™è¨˜çš„æ­¥é©Ÿæ˜¯é˜²æ­¢ Registration API 500 éŒ¯èª¤çš„é—œéµ
# - å¦‚æœéƒ¨ç½²å¾Œ Registration API å¤±æ•—,é¦–å…ˆæª¢æŸ¥ seed data æ˜¯å¦åŸ·è¡ŒæˆåŠŸ
# - å¯ä»¥æ‰‹å‹•åŸ·è¡Œ `pnpm db:seed:minimal` ä¾†ä¿®å¾© seed data å•é¡Œ
# ============================================================================
