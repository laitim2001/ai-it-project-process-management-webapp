# 11. 安全、性能與可觀測性

本章節定義了確保應用程式穩健、安全和高效運行的關鍵策略。

### 11.1. 安全策略 (Security)

*   **身份验证:** 所有需要登录的 API 路由都将通过 `protectedProcedure` 进行保护，该程序会验证来自 Azure AD B2C 的 JWT。
*   **网络安全:** Azure App Service 将配置在虚拟网络 (VNet) 中，并通过网络安全组 (NSG) 规则限制对数据库和其他内部服务的访问。
*   **密钥管理:** 所有敏感信息，如数据库连接字符串、API 密钥等，都将存储在 **Azure Key Vault** 中。应用在启动时将通过托管身份 (Managed Identity) 从 Key Vault 中安全地检索这些密钥。
*   **输入验证:** 所有 tRPC API 的输入都将使用 Zod 进行严格的服务器端验证，以防止注入攻击。

### 11.2. 错误处理与日志 (Error Handling & Logging)

*   **统一错误处理:** 后端将实现一个全局的 tRPC 中间件来捕獲所有未處理的異常，并将其格式化为统一的错误响应，同时防止堆栈跟踪等敏感信息泄露到客户端。
*   **结构化日志:** 我们将使用 `pino` 等库来实现结构化日志。所有日志（包括请求日志、错误日志、业务事件日志）都将以 JSON 格式输出。
*   **日志聚合:** Azure App Service 将配置为将所有应用日志流式传输到 **Azure Monitor (Log Analytics Workspace)**。这为我们提供了一个集中的地方来查询、分析和告警所有环境的日志。

### 11.3. 监控与可观测性 (Monitoring & Observability)

*   **应用性能监控 (APM):** 我们将启用 **Azure Application Insights**。它会自动收集有关我们应用的性能指标（如服务器响应时间、请求率、失败率）、服务器遥测（CPU、内存）以及未處理的異常。
*   **前端监控:** 在 Next.js 应用中，我们将集成 Application Insights 的前端 SDK，以收集客户端的页面浏览量、性能数据（如 LCP）和前端异常。
*   **告警 (Alerting):** 在 Azure Monitor 中，我们将配置告警规则。例如，当 "服务器错误率在 5 分钟内超过 1%" 或 "平均服务器响应时间超过 2 秒" 时，会自动向开发团队发送通知。
