# 測試驗證 Sprint: 現有功能全面測試與完善

> **Sprint 類型**: 測試與驗證 Sprint (非功能開發)
> **時間**: 2025-W46 ~ 2025-W48 (預計 2-3 週)
> **目標**: 全面測試現有 8 個核心模組,識別並修復所有錯誤,確保所有功能符合預期
> **優先級**: 🔴 P0 (最高優先級 - 阻擋新功能開發)

---

## 🎯 Sprint 目標

### 主要目標
1. **全面測試現有 8 個核心模組**,覆蓋所有使用者操作流程
2. **識別並記錄所有錯誤**,包括功能錯誤、顯示問題、流程異常
3. **修復所有已識別的問題**,確保系統穩定可靠
4. **驗證所有工作流程**,確保符合業務預期和使用者需求

### 成功標準
- ✅ 所有 8 個模組完成系統化測試
- ✅ 所有發現的 🔴 P0/P1 錯誤已修復並驗證
- ✅ 所有核心工作流程端到端驗證通過
- ✅ 使用者體驗流暢,無明顯卡頓或錯誤
- ✅ 所有修復都有完整的 FIX-XXX.md 文檔

---

## 📋 測試範圍

### 1. 預算池模組 (Budget Pool) - Epic 2
**頁面**: `/budget-pools`, `/budget-pools/[id]`, `/budget-pools/new`, `/budget-pools/[id]/edit`

**測試項目**:
- [ ] **CRUD 操作**
  - [ ] 創建新預算池 (名稱、總金額、財務年度)
  - [ ] 查看預算池列表 (排序、分頁、搜尋)
  - [ ] 查看預算池詳情 (基本資訊、關聯專案、使用率)
  - [ ] 編輯預算池資訊
  - [ ] 刪除預算池 (含驗證:不可刪除已有專案的池)

- [ ] **即時追蹤 (Epic 6.5)**
  - [ ] 驗證 `usedAmount` 即時更新 (當專案預算變更時)
  - [ ] 驗證預算使用率計算正確 (usedAmount / totalAmount * 100)
  - [ ] 驗證健康狀態顯示 (綠色 <70%, 黃色 70-90%, 紅色 >90%)

- [ ] **資料驗證**
  - [ ] 名稱必填驗證
  - [ ] 總金額必須 > 0
  - [ ] 財務年度格式驗證 (YYYY)
  - [ ] 重複名稱檢查

- [ ] **權限控制**
  - [ ] PM 可查看、創建、編輯
  - [ ] Supervisor 可查看、創建、編輯、刪除
  - [ ] 未登入無法訪問

**預期問題**:
- 可能存在預算使用率計算不準確
- 刪除時未正確檢查關聯專案
- 顯示已使用金額與實際不符

---

### 2. 專案管理模組 (Project Management) - Epic 2
**頁面**: `/projects`, `/projects/[id]`, `/projects/new`, `/projects/[id]/edit`

**測試項目**:
- [ ] **CRUD 操作**
  - [ ] 創建新專案 (名稱、預算池、經理、主管、日期)
  - [ ] 查看專案列表 (篩選、排序、分頁)
  - [ ] 查看專案詳情 (基本資訊、預算提案、採購單、支出)
  - [ ] 編輯專案資訊
  - [ ] 刪除專案 (含驗證:不可刪除已有提案的專案)

- [ ] **關聯管理**
  - [ ] 驗證預算池選擇 (下拉清單)
  - [ ] 驗證經理選擇 (僅顯示 PM 角色使用者)
  - [ ] 驗證主管選擇 (僅顯示 Supervisor 角色使用者)
  - [ ] 驗證關聯預算提案顯示
  - [ ] 驗證關聯採購單顯示
  - [ ] 驗證關聯支出顯示

- [ ] **資料驗證**
  - [ ] 專案名稱必填且唯一
  - [ ] 預算池必選
  - [ ] 經理、主管必選
  - [ ] 開始日期 <= 結束日期
  - [ ] 日期格式驗證

- [ ] **權限控制**
  - [ ] PM 可創建、編輯自己管理的專案
  - [ ] Supervisor 可查看、編輯所有專案
  - [ ] PM 不可編輯他人專案

**預期問題**:
- 專案列表篩選可能不正確
- 刪除專案時未檢查關聯資料
- 日期驗證邏輯可能有漏洞

---

### 3. 預算提案模組 (Budget Proposals) - Epic 3
**頁面**: `/proposals`, `/proposals/[id]`, `/proposals/new`, `/proposals/[id]/edit`

**測試項目**:
- [ ] **CRUD 操作**
  - [ ] 創建新提案 (專案、金額、說明)
  - [ ] 查看提案列表 (篩選狀態、排序)
  - [ ] 查看提案詳情 (基本資訊、評論、歷史)
  - [ ] 編輯提案 (僅限 Draft 狀態)
  - [ ] 刪除提案 (僅限 Draft 狀態)

- [ ] **工作流程狀態機 (Epic 3)**
  - [ ] Draft → PendingApproval (提交審核)
  - [ ] PendingApproval → Approved (主管批准)
  - [ ] PendingApproval → Rejected (主管拒絕)
  - [ ] PendingApproval → MoreInfoRequired (要求更多資訊)
  - [ ] MoreInfoRequired → PendingApproval (補充資訊後重新提交)
  - [ ] 驗證狀態轉換權限 (PM 提交, Supervisor 審批)

- [ ] **評論系統**
  - [ ] PM 和 Supervisor 可新增評論
  - [ ] 評論顯示作者、時間、內容
  - [ ] 評論按時間排序 (最新在上)
  - [ ] 評論不可編輯或刪除 (審計追蹤)

- [ ] **歷史追蹤**
  - [ ] 所有狀態變更記錄到 History
  - [ ] 歷史顯示操作者、時間、動作、備註
  - [ ] 歷史按時間排序 (最新在上)

- [ ] **通知整合 (Epic 8)**
  - [ ] 提交審核時發送通知給 Supervisor
  - [ ] 批准/拒絕時發送通知給 PM
  - [ ] 要求更多資訊時發送通知給 PM

**預期問題**:
- 狀態轉換邏輯可能有漏洞 (允許非法轉換)
- 評論可能未正確關聯到提案
- 歷史記錄可能遺漏某些操作
- 通知可能未正確觸發

---

### 4. 供應商模組 (Vendors) - Epic 5
**頁面**: `/vendors`, `/vendors/[id]`, `/vendors/new`, `/vendors/[id]/edit`

**測試項目**:
- [ ] **CRUD 操作**
  - [ ] 創建新供應商 (名稱、聯絡人、Email、電話)
  - [ ] 查看供應商列表 (搜尋、排序、分頁)
  - [ ] 查看供應商詳情 (基本資訊、關聯報價單、採購單)
  - [ ] 編輯供應商資訊
  - [ ] 刪除供應商 (含驗證:不可刪除已有報價/採購單的供應商)

- [ ] **資料驗證**
  - [ ] 供應商名稱必填且唯一
  - [ ] Email 格式驗證
  - [ ] 電話格式驗證 (可選)
  - [ ] 聯絡人姓名驗證

- [ ] **關聯管理**
  - [ ] 驗證關聯報價單列表顯示
  - [ ] 驗證關聯採購單列表顯示
  - [ ] 驗證刪除時檢查關聯資料

**預期問題**:
- Email 格式驗證可能不嚴格
- 刪除供應商時未檢查關聯資料
- 重複名稱檢查可能失效

---

### 5. 報價單模組 (Quotes) - Epic 5
**頁面**: `/quotes`, `/quotes/[id]`, `/quotes/new`

**測試項目**:
- [ ] **CRUD 操作**
  - [ ] 創建新報價單 (供應商、專案、金額、檔案上傳)
  - [ ] 查看報價單列表 (篩選專案、排序)
  - [ ] 查看報價單詳情 (基本資訊、檔案連結、關聯採購單)
  - [ ] 下載報價單檔案
  - [ ] 刪除報價單 (含驗證:不可刪除已轉採購單的報價)

- [ ] **檔案上傳 (Azure Blob Storage)**
  - [ ] 上傳 PDF 檔案
  - [ ] 上傳 Excel 檔案
  - [ ] 檔案大小限制驗證 (10MB)
  - [ ] 檔案類型驗證 (僅 PDF, Excel)
  - [ ] 檔案安全掃描 (若有)

- [ ] **資料驗證**
  - [ ] 供應商必選
  - [ ] 專案必選
  - [ ] 金額必須 > 0
  - [ ] 檔案上傳必填 (或可選?)

**預期問題**:
- 檔案上傳可能失敗但未正確顯示錯誤
- 檔案下載連結可能過期或無效
- 刪除報價時未檢查關聯採購單

---

### 6. 採購單模組 (Purchase Orders) - Epic 5
**頁面**: `/purchase-orders`, `/purchase-orders/[id]`

**測試項目**:
- [ ] **採購單生成**
  - [ ] 從報價單生成採購單 (單報價單 → 單採購單)
  - [ ] 從報價單生成採購單 (多報價單 → 單採購單, 若支援)
  - [ ] 驗證採購單編號自動生成 (PO-YYYYMMDD-XXX)
  - [ ] 驗證總金額正確 (sum of quote amounts)

- [ ] **查看與管理**
  - [ ] 查看採購單列表 (篩選專案、日期範圍)
  - [ ] 查看採購單詳情 (基本資訊、關聯報價單、關聯支出)
  - [ ] 驗證關聯報價單顯示
  - [ ] 驗證關聯支出顯示

- [ ] **資料驗證**
  - [ ] PO 編號唯一性
  - [ ] 總金額 > 0
  - [ ] PO 日期不可未來日期
  - [ ] 不可刪除已有支出的 PO

**預期問題**:
- PO 編號生成邏輯可能重複
- 總金額計算可能不正確
- 關聯支出顯示可能不完整

---

### 7. 支出管理模組 (Expenses) - Epic 6
**頁面**: `/expenses`, `/expenses/[id]`, `/expenses/new`, `/expenses/[id]/edit`

**測試項目**:
- [ ] **CRUD 操作**
  - [ ] 創建新支出 (採購單、金額、日期、發票上傳)
  - [ ] 查看支出列表 (篩選狀態、專案、日期)
  - [ ] 查看支出詳情 (基本資訊、發票、審批歷史)
  - [ ] 編輯支出 (僅限 Draft 狀態)
  - [ ] 刪除支出 (僅限 Draft 狀態)

- [ ] **工作流程狀態機**
  - [ ] Draft → PendingApproval (提交審核)
  - [ ] PendingApproval → Approved (主管批准)
  - [ ] PendingApproval → Rejected (主管拒絕)
  - [ ] Approved → Paid (標記已支付)
  - [ ] 驗證狀態轉換權限

- [ ] **發票上傳**
  - [ ] 上傳發票 PDF
  - [ ] 上傳發票圖片 (JPG, PNG)
  - [ ] 檔案大小限制驗證
  - [ ] 檔案類型驗證
  - [ ] 下載發票檔案

- [ ] **費用轉嫁 (Charge-Out)**
  - [ ] 批准支出時自動更新預算池 `usedAmount`
  - [ ] 驗證預算池剩餘金額更新正確
  - [ ] 驗證專案已使用預算更新正確
  - [ ] 驗證不可超支 (支出金額 > 剩餘預算 → 警告或阻擋)

- [ ] **通知整合 (Epic 8)**
  - [ ] 提交審核時發送通知給 Supervisor
  - [ ] 批准/拒絕時發送通知給 PM

**預期問題**:
- 費用轉嫁邏輯可能不正確 (usedAmount 未更新)
- 超支檢查可能失效
- 發票上傳可能失敗
- 狀態轉換邏輯可能有漏洞

---

### 8. 費用轉嫁功能 (Charge-Out) - Epic 6
**整合測試** (橫跨預算池、專案、支出)

**測試場景**:
- [ ] **場景 1: 正常費用轉嫁流程**
  1. 創建預算池 (總金額 100,000)
  2. 創建專案 A (關聯預算池)
  3. 創建預算提案 (金額 30,000) → 批准
  4. 創建採購單 (金額 30,000)
  5. 創建支出 (金額 15,000) → 提交 → 批准
  6. **驗證**: 預算池 usedAmount = 15,000
  7. 創建支出 (金額 10,000) → 提交 → 批准
  8. **驗證**: 預算池 usedAmount = 25,000

- [ ] **場景 2: 多專案費用轉嫁**
  1. 創建預算池 (總金額 200,000)
  2. 創建專案 A (關聯預算池)
  3. 創建專案 B (關聯同一預算池)
  4. 專案 A 支出 50,000 → 批准
  5. 專案 B 支出 30,000 → 批准
  6. **驗證**: 預算池 usedAmount = 80,000

- [ ] **場景 3: 超支警告**
  1. 創建預算池 (總金額 50,000)
  2. 創建專案 (關聯預算池)
  3. 創建支出 (金額 60,000) → 提交
  4. **驗證**: 系統顯示超支警告
  5. **驗證**: Supervisor 批准時顯示二次確認

- [ ] **場景 4: 支出拒絕後回滾**
  1. 創建支出 (金額 10,000) → 提交 → 批准 (usedAmount +10,000)
  2. 發現錯誤,支出被拒絕
  3. **驗證**: usedAmount 是否回滾? (需確認業務邏輯)

**預期問題**:
- usedAmount 計算可能不準確 (漏加或重複加)
- 多專案競爭條件 (race condition)
- 超支檢查可能被繞過
- 狀態回滾邏輯可能缺失

---

## 🔧 測試方法

### 1. 手動測試 (Manual Testing)
- **工具**: Chrome DevTools, 網路面板
- **方法**:
  - 逐一執行測試項目清單
  - 記錄所有錯誤和異常行為
  - 截圖保存錯誤畫面
  - 記錄復現步驟

### 2. 自動化測試 (Automated Testing)
- **E2E 測試**: Playwright
- **單元測試**: Jest + React Testing Library
- **API 測試**: tRPC client test
- **執行**: `pnpm test`, `pnpm test:e2e`

### 3. 資料庫驗證
- **工具**: Prisma Studio (`pnpm db:studio`)
- **方法**:
  - 驗證資料正確寫入
  - 驗證關聯正確建立
  - 驗證狀態正確更新

### 4. 效能測試
- **工具**: Chrome DevTools (Performance, Network)
- **指標**:
  - 頁面載入時間 < 2 秒
  - API 回應時間 < 500ms
  - 無記憶體洩漏

---

## 📊 錯誤記錄格式

### 錯誤分類
- 🔴 **P0 (Critical)**: 系統崩潰、資料遺失、無法使用核心功能
- 🟠 **P1 (High)**: 主要功能錯誤、顯示嚴重錯誤、工作流程中斷
- 🟡 **P2 (Medium)**: 次要功能錯誤、顯示小錯誤、使用者體驗問題
- 🟢 **P3 (Low)**: 美觀問題、優化建議、非關鍵功能

### 錯誤文檔模板
對每個發現的錯誤,創建 `claudedocs/4-changes/bug-fixes/FIX-XXX-[描述].md`:

```markdown
# FIX-XXX: [錯誤簡述]

**優先級**: 🔴 P0 / 🟠 P1 / 🟡 P2 / 🟢 P3
**模組**: [預算池 / 專案管理 / ...]
**發現日期**: 2025-11-XX
**修復日期**: 2025-11-XX

## 問題描述
[詳細描述錯誤,包括復現步驟]

**復現步驟**:
1. 步驟 1
2. 步驟 2
3. 步驟 3

**預期結果**: [應該如何]
**實際結果**: [實際如何]
**錯誤訊息**: [錯誤訊息或截圖]

## 根本原因 (5 Why Analysis)
1. **為什麼發生這個錯誤?** [原因 1]
2. **為什麼會出現 [原因 1]?** [原因 2]
3. **為什麼會出現 [原因 2]?** [原因 3]
4. **為什麼沒有被發現?** [原因 4]
5. **根本原因是什麼?** [根本原因]

## 解決方案
[描述解決方案,包括程式碼變更]

**修改文件**:
- `文件路徑` - [變更說明]

## 測試驗證
- ✅ [測試項目 1]
- ✅ [測試項目 2]
- ✅ 回歸測試通過

## 預防措施
[如何防止類似問題再次發生]

## 相關 Commit
- Commit: [commit hash]
```

---

## 📅 時間規劃

### Week 1 (2025-W46): 模組 1-4
- **Day 1-2**: 預算池模組測試 + 問題修復
- **Day 3-4**: 專案管理模組測試 + 問題修復
- **Day 5**: 預算提案模組測試 (Part 1)

### Week 2 (2025-W47): 模組 5-8
- **Day 1-2**: 預算提案模組測試 (Part 2) + 問題修復
- **Day 3**: 供應商、報價單模組測試 + 問題修復
- **Day 4**: 採購單模組測試 + 問題修復
- **Day 5**: 支出管理模組測試 + 問題修復

### Week 3 (2025-W48): 整合測試與驗證
- **Day 1-2**: 費用轉嫁整合測試 + 問題修復
- **Day 3**: 端到端流程驗證 (完整業務流程)
- **Day 4**: 效能測試 + 優化
- **Day 5**: 最終驗證 + 測試報告

---

## ✅ 驗收標準

### 完成條件
- [ ] 所有 8 個模組完成系統化測試
- [ ] 所有 🔴 P0 錯誤已修復並驗證
- [ ] 所有 🟠 P1 錯誤已修復並驗證
- [ ] 至少 80% 🟡 P2 錯誤已修復
- [ ] 所有核心工作流程端到端驗證通過
- [ ] 所有修復都有完整的 FIX-XXX.md 文檔
- [ ] 所有測試結果記錄到測試報告
- [ ] Git 提交訊息清楚,程式碼品質檢查通過

### 測試報告
創建 `claudedocs/5-status/testing-validation-report.md`:
- 測試覆蓋率統計
- 發現的錯誤清單 (按優先級分類)
- 修復的錯誤清單
- 未修復的錯誤清單 (含原因)
- 效能測試結果
- 建議與後續行動

---

## 🔗 相關文檔

- [DEBUG-ISSUES Session Guide](../6-ai-assistant/session-guides/DEBUG-ISSUES.md)
- [FIXLOG.md](../../FIXLOG.md) - Bug 修復歷史記錄
- [MASTER-ROADMAP.md](../1-planning/roadmap/MASTER-ROADMAP.md)
- [Epic 1-8 User Stories](../../docs/stories/)

---

**創建日期**: 2025-11-10
**維護者**: 開發團隊
**狀態**: 🔄 執行中
