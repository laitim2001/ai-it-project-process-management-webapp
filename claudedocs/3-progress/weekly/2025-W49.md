# 2025-W49 每週進度 (12月1日 - 12月6日)

## 本週目標
- [x] 完成 FEAT-005: OM Expense Category Management 功能開發
- [x] 完成 CHANGE-001: OMExpense 來源追蹤功能
- [x] 完成 CHANGE-002: ExpenseItem 費用轉嫁目標功能 (Backend + Frontend)
- [ ] 功能測試和驗證
- [ ] 準備下一個功能開發

## 完成情況

### 已完成
- ✅ **FEAT-005: OM Expense Category Management** - OM 費用類別管理完整實現
  - Phase 0: 規劃和需求分析（4 份規劃文檔）
  - Phase 1: 後端開發
    - 新增 `OMExpenseCategory` Prisma Model
    - 修改 `OMExpense` Model 新增 categoryId 關聯
    - 建立 `omExpenseCategory` tRPC Router（完整 CRUD + toggleStatus）
  - Phase 2: 前端開發
    - 建立組件：OMExpenseCategoryForm, OMExpenseCategoryActions
    - 建立頁面：列表、新增、編輯
    - 新增 48 個 I18N 翻譯鍵
  - Phase 3: 整合測試
    - i18n 驗證通過（1954 個鍵）
    - ESLint 問題已修復
    - TypeScript 類型錯誤已修復

- ✅ **CHANGE-001: OMExpense 來源追蹤** (Phase 1+2+3 完成)
  - Phase 1: Schema 修改
    - `OMExpense` 新增 `sourceExpenseId` 欄位
    - `OMExpense` 新增 `sourceExpense` 關聯到 Expense
    - `Expense` 新增 `derivedOMExpenses` 反向關聯
  - Phase 2: API 更新
    - `omExpense.ts` 更新 create/update mutation
    - 新增 `getBySourceExpenseId` 查詢
    - 所有 include 加入 sourceExpense 關聯
  - Phase 3: 前端更新
    - `OMExpenseForm.tsx` 新增來源費用選擇器
    - 新增 sourceExpense 相關翻譯鍵
    - 顯示關聯專案和採購單資訊

- ✅ **CHANGE-002: ExpenseItem 費用轉嫁目標** (Phase 1+2+3 完成 + Bug Fixes)
  - Phase 1: Schema 修改
    - `ExpenseItem` 新增 `chargeOutOpCoId` 欄位
    - `ExpenseItem` 新增 `chargeOutOpCo` 關聯到 OperatingCompany
    - `ChargeOutItem` 新增 `expenseItemId` 欄位
    - `ChargeOutItem.expenseId` 改為可選（向後兼容）
    - `OperatingCompany` 新增 `chargeOutExpenseItems` 反向關聯
  - Phase 2: API 更新
    - `expense.ts` 的 expenseItemSchema 新增 chargeOutOpCoId
    - `chargeOut.ts` 的 chargeOutItemSchema 新增 expenseItemId
    - 更新所有 create/update mutation 處理新欄位
    - 更新 getById/getEligibleExpenses 包含完整關聯
  - Phase 3: 前端更新
    - `ExpenseForm.tsx` 新增 chargeOutOpCoId OpCo 選擇器
    - `ChargeOutForm.tsx` 新增 expenseItemId ExpenseItem 選擇器
    - 新增 chargeOutOpCo 和 expenseItem 相關翻譯鍵
    - TypeScript 錯誤修復
  - **Bug Fixes (12/1)**:
    - 修復 ExpenseForm 編輯模式 defaultValues 載入問題（projectId, vendorId, requiresChargeOut）
    - 修復 updateExpenseSchema 缺少欄位（requiresChargeOut, isOperationMaint, purchaseOrderId, budgetCategoryId）
    - 修復 update mutation handler 未處理這些欄位
    - 新增邏輯：當 requiresChargeOut 從 true 變為 false 時，自動清除所有 ExpenseItem 的 chargeOutOpCoId

- ✅ **i18n 錯誤修復**
  - 修復 ExpenseForm.tsx 的 FORMATTING_ERROR
  - 問題: 翻譯字串期望 `{name}` 參數但使用 `.replace()` 方法
  - 解決: 改用正確的 next-intl 參數語法 `t('key', { name: value })`

- ✅ **UI 組件優化**
  - 擴展 DropdownMenuItem 支援 onClick, asChild, disabled 屬性
  - 修正 Select 組件用法（改用原生 HTML select）
  - 修正 use-toast import 路徑

- ✅ **開發環境設置**
  - Docker 服務啟動（PostgreSQL, Redis, Mailhog, Azurite）
  - Prisma Client 重新生成
  - 資料庫 Schema 同步（db push）

- ✅ **CHANGE-003: 統一費用類別系統** (12/2 完成)
  - Phase 1: Schema 修改
    - 重命名 `OMExpenseCategory` → `ExpenseCategory`（統一命名）
    - `ExpenseItem` 新增 `categoryId` 欄位（FK 到 ExpenseCategory）
  - Phase 2: API 更新
    - 重命名 `omExpenseCategory` Router → `expenseCategory`
    - 更新 `packages/api/src/root.ts` Router 導入
    - 新增 `getActive` 查詢供下拉選單使用
  - Phase 3: 前端更新
    - `ExpenseForm.tsx` 改用動態類別（`api.expenseCategory.getActive`）
    - `OMExpenseForm.tsx` 改用統一 API
    - 更新 om-expense-categories 頁面和組件使用新 API
  - Phase 4: Seed Data
    - 新增 8 個預設費用類別（HW, SW, SV, MAINT, LICENSE, CLOUD, TELECOM, OTHER）
    - 同步更新 `seed.ts` 和 `seed-minimal.ts`
  - Phase 5: 驗證
    - TypeScript 驗證通過（無 CHANGE-003 相關錯誤）
    - 資料庫已成功插入 8 個類別

- ✅ **i18n 修復** (12/2)
  - 新增 `common.actions.openMenu` 翻譯鍵（zh-TW + en）
  - 修復 OMExpenseCategoryActions.tsx IntlError

- ✅ **TypeScript/ESLint 錯誤修復** (12/2)
  - `azure-storage.ts`: 修復 File/Buffer 類型收窄和 chunk 類型處理
  - `exportUtils.ts`: 修復 possibly undefined 數組存取問題
  - `@itpm/auth`: 修復 ESLint 錯誤（28 errors → 0 errors）
    - 添加 `AzureADProfile` 介面定義
    - 修正 JWT callback 和 session callback 類型
    - 移除未使用的 imports

- ✅ **資料遷移** (12/2)
  - 完成 ExpenseItem categoryId 遷移（80 筆記錄）
  - 完成 OMExpense categoryId 遷移（4 筆記錄）
  - 未知類別值自動映射到 "其他" 類別

- ✅ **Azure 部署問題修復** (12/3) - **重大修復**
  - 問題：Azure 部署後所有頁面返回 500 錯誤（除了 /zh-TW/dashboard）
  - 根本原因分析（4 個問題）：
    1. **Prisma Client Docker 生成失敗** - `pnpm db:generate` 在 Docker 中失敗
    2. **OpenSSL 3.0 相容性問題** - Alpine 3.22 移除 OpenSSL 1.1
    3. **Post-MVP 表格缺失** - ExpenseCategory 等表格未創建
    4. **Migration 卡住** - finishedAt 為 null 導致 migration 無法重試
  - 解決方案：
    - Dockerfile 改用 `npx prisma generate` 直接執行
    - 添加 `PRISMA_QUERY_ENGINE_LIBRARY` 環境變數指向 OpenSSL 3.0 engine
    - 新增 `health.schemaCheck` API 診斷表格狀態
    - 新增 `health.fixMigration` API 創建缺失表格並標記 migration 完成
  - 部署版本：v16-fix-migration
  - 驗證結果：所有 9 個 Post-MVP 表格已創建，API 正常運作

- ✅ **部署文檔更新** (12/3)
  - 更新 `SITUATION-7-AZURE-DEPLOY-COMPANY.md` 至 v1.6.0
  - 新增問題 0.8: Prisma Client Docker 生成失敗
  - 新增問題 0.9: OpenSSL 3.0 相容性問題
  - 新增問題 0.10: Migration 卡住
  - 新增 Health API 診斷工具章節
  - 更新部署檢查清單（6 項新增檢查項目）

- ✅ **部署文檔重組** (12/3) - **重大更新**
  - **SITUATION-7** 重寫為簡潔部署流程指南（v2.0.0）
    - 從 2,333 行精簡至 ~430 行
    - 專注於「最新和最正確的部署流程」
    - 4 個清晰的部署階段（環境準備、建置映像、推送部署、驗證）
    - 包含基於實戰經驗的關鍵提醒
  - **SITUATION-9** 更新為完整故障排查指南（v2.0.0）
    - 新增問題 0.11: Azure Storage 環境變數未配置
    - 新增問題 0.12: omExpense API 返回 500（已解決）
    - 新增 Health API 診斷工具完整指南
    - 記錄所有歷史問題和解決方案

- ✅ **omExpense API 500 錯誤修復** (12/3)
  - 問題：omExpense.getAll 和 omExpense.getSummary 返回 500
  - 根本原因：OMExpense 表缺少 `categoryId` 和 `sourceExpenseId` 欄位
  - 解決方案：創建 `health.fixOmExpenseSchema` API 端點添加缺失欄位
  - 部署版本：v18-fix-omexpense-schema
  - 驗證結果：API 正常返回 401 UNAUTHORIZED（需要認證）

- ✅ **Azure Storage 環境變數配置** (12/3)
  - 配置 AZURE_STORAGE_ACCOUNT_NAME, AZURE_STORAGE_ACCOUNT_KEY
  - 配置 AZURE_STORAGE_CONTAINER_QUOTES, AZURE_STORAGE_CONTAINER_INVOICES
  - 確認 Blob 容器 quotes 和 invoices 已存在

- ✅ **Azure Storage 認證修復** (12/3)
  - 問題：Quote 上傳返回 `ChainedTokenCredential authentication failed`
  - 根本原因：代碼使用 `DefaultAzureCredential` 而非 Storage Account Key
  - 解決方案：修改 `azure-storage.ts` 優先使用 Storage Account Key 認證
  - 部署版本：v19-fix-storage-auth

### 進行中
- （無進行中項目）

### 未開始
- （本週任務已全部完成）

## 遇到的挑戰

### 挑戰 1: Prisma generate Windows 檔案鎖定
- **問題**: 開發伺服器運行時無法重新生成 Prisma Client
- **解決方案**: 停止開發伺服器後再執行 `prisma generate`
- **學習**: Windows 環境的檔案鎖定需特別注意

### 挑戰 2: Select 組件 API 不相容
- **問題**: 專案的 Select 組件不支援 Radix UI 的 onValueChange API
- **解決方案**: 改用原生 HTML select 方式（onChange + option）
- **學習**: 使用前先確認組件 API 支援

### 挑戰 3: DropdownMenuItem 缺少屬性
- **問題**: 專案的 DropdownMenuItem 不支援 onClick 和 asChild
- **解決方案**: 擴展組件支援這些屬性
- **學習**: 簡化版 UI 組件可能需要按需擴展

### 挑戰 4: use-toast import 路徑
- **問題**: 錯誤使用 `@/hooks/use-toast`
- **解決方案**: 修正為 `@/components/ui/use-toast`
- **學習**: 注意專案的檔案組織結構

### 挑戰 5: next-intl 參數傳遞
- **問題**: 翻譯字串含參數時使用錯誤的 `.replace()` 方法
- **解決方案**: 使用正確的 next-intl 參數語法 `t('key', { param: value })`
- **學習**: 遵循 next-intl 官方文檔的參數傳遞方式

### 挑戰 6: TypeScript 類型錯誤 - 可選欄位過濾
- **問題**: `chargeOut.ts` 中過濾 expenseId 時產生 `(string | null | undefined)[]` 類型
- **解決方案**: 使用類型守衛 `.filter((id): id is string => id !== null && id !== undefined)`
- **學習**: 可選欄位映射後需要正確的類型過濾

### 挑戰 7: Expense 編輯模式資料載入問題
- **問題**: ExpenseForm 編輯頁面無法正確載入 projectId, vendorId, requiresChargeOut 等欄位
- **原因 1**: Expense model 沒有直接的 projectId 欄位，需從 `purchaseOrder.project.id` 取得
- **原因 2**: 使用 `|| false` 導致 boolean false 值被覆蓋
- **原因 3**: updateExpenseSchema 缺少這些欄位定義
- **解決方案**:
  1. defaultValues 改用正確路徑 (`initialData?.purchaseOrder?.project?.id`)
  2. boolean 欄位改用 `??` nullish coalescing
  3. 補齊 updateExpenseSchema 和 mutation handler 的欄位支援
- **學習**: Prisma 關聯資料的取得路徑需與 model 結構一致

### 挑戰 8: Docker 中 pnpm filter 命令失敗 (12/3)
- **問題**: `pnpm --filter @itpm/db run db:generate` 在 Docker 中報告 "None of the selected packages has a 'prisma' script"
- **原因**: pnpm 在 Docker 多階段建置中的 workspace 解析問題
- **解決方案**: 直接使用 `npx prisma generate --schema=./prisma/schema.prisma`
- **學習**: Docker 環境中優先使用 npx 直接執行，避免 pnpm filter 問題

### 挑戰 9: Alpine 3.22 移除 OpenSSL 1.1 (12/3)
- **問題**: Prisma Query Engine 報錯 "Error loading shared library libssl.so.1.1"
- **原因**: Node.js 20-alpine 基於 Alpine 3.22，已移除 OpenSSL 1.1
- **嘗試失敗**: `apk add openssl1.1-compat` 套件不存在
- **解決方案**: 設置 `PRISMA_QUERY_ENGINE_LIBRARY` 環境變數指向 OpenSSL 3.0 版本的 engine
- **學習**: Alpine 版本更新時需注意系統庫的變化

### 挑戰 10: Migration 卡住無法重試 (12/3)
- **問題**: Migration 執行中斷後，`_prisma_migrations` 表中 `finishedAt` 為 null，後續啟動跳過執行
- **原因**: Prisma 認為 migration 正在進行中，不會重新執行
- **解決方案**: 創建 `health.fixMigration` API 端點，手動創建缺失表格並更新 `finishedAt`
- **學習**: 需要診斷和修復工具來處理 migration 異常狀態

## 技術決策
- **決策 1**: 選擇方案 A - 建立獨立的 OMExpenseCategory Model
  - 選項 A: 獨立 Model + FK 關聯
  - 選項 B: 繼續使用 String category
  - 選擇: A → 更好的資料完整性和可維護性

- **決策 2**: 遷移策略 - 分階段遷移
  - 先新增 categoryId 為可選欄位
  - 後續再移除舊 category String 欄位
  - 理由: 避免破壞現有資料

- **決策 3**: CHANGE-002 ChargeOutItem 向後兼容
  - 新增 expenseItemId 欄位（可選）
  - 保留 expenseId 欄位為可選
  - 理由: 現有資料不受影響，支援漸進式遷移

## 下週計劃
- [ ] 完成 FEAT-005 功能測試
- [ ] 更新 Seed Data 添加預設類別
- [ ] 考慮資料遷移策略
- [ ] 準備下一個功能開發

## 風險提示
- ✅ ~~現有 OMExpense 資料需要遷移~~ - **已完成遷移**
- ⚠️ 現有 ChargeOutItem 資料（expenseItemId 為 null）
- ✅ ~~剩餘 TypeScript 錯誤~~ - **已修復**

## 統計數據
- **代碼行數**: +3,400 / -200
- **文件變更**: 42+ 個
- **Commits**: 8 次（預計）
  - `feat(om-expense-categories): 完成 FEAT-005 OM 費用類別管理功能`
  - `fix(om-expense-categories): 修復 TypeScript 類型錯誤`
  - `feat(om-expense): 實施 CHANGE-001 來源費用追蹤功能`
  - `feat(expense,chargeout): 實施 CHANGE-002 費用明細轉嫁目標功能 (Backend)`
  - `docs: 更新 CHANGE-001 和 CHANGE-002 開發記錄與每週進度`
  - `feat(expense,chargeout): 完成 CHANGE-002 Phase 3 前端更新`
  - `fix(expense): 修復 Expense 編輯功能的多個欄位更新問題`
- **工作時間**: ~8 小時

## 修改的文件

### CHANGE-001 相關
**後端**
- `packages/db/prisma/schema.prisma` - OMExpense 新增 sourceExpenseId, Expense 新增 derivedOMExpenses
- `packages/api/src/routers/omExpense.ts` - 新增 sourceExpenseId 處理

**前端**
- `apps/web/src/components/om-expense/OMExpenseForm.tsx` - 新增來源費用選擇器
- `apps/web/src/components/expense/ExpenseForm.tsx` - 修復 i18n 錯誤
- `apps/web/src/messages/zh-TW.json` - sourceExpense 翻譯
- `apps/web/src/messages/en.json` - sourceExpense 翻譯

**文檔**
- `claudedocs/4-changes/feature-changes/CHANGE-001-omexpense-source-tracking.md`

### CHANGE-002 相關
**後端**
- `packages/db/prisma/schema.prisma` - ExpenseItem 新增 chargeOutOpCoId, ChargeOutItem 新增 expenseItemId
- `packages/api/src/routers/expense.ts` - expenseItemSchema 新增 chargeOutOpCoId
- `packages/api/src/routers/chargeOut.ts` - chargeOutItemSchema 新增 expenseItemId

**前端 (Phase 3)**
- `apps/web/src/components/expense/ExpenseForm.tsx` - 新增 chargeOutOpCoId OpCo 選擇器
- `apps/web/src/components/charge-out/ChargeOutForm.tsx` - 新增 expenseItemId ExpenseItem 選擇器
- `apps/web/src/messages/zh-TW.json` - chargeOutOpCo, expenseItem 翻譯
- `apps/web/src/messages/en.json` - chargeOutOpCo, expenseItem 翻譯

**文檔**
- `claudedocs/4-changes/feature-changes/CHANGE-002-expenseitem-chargeout-target.md`

### FEAT-005 相關（16 個）
**後端**
- `packages/api/src/routers/omExpenseCategory.ts` - tRPC Router

**前端組件**
- `apps/web/src/components/om-expense-category/index.ts`
- `apps/web/src/components/om-expense-category/OMExpenseCategoryForm.tsx`
- `apps/web/src/components/om-expense-category/OMExpenseCategoryActions.tsx`

**前端頁面**
- `apps/web/src/app/[locale]/om-expense-categories/page.tsx`
- `apps/web/src/app/[locale]/om-expense-categories/new/page.tsx`
- `apps/web/src/app/[locale]/om-expense-categories/[id]/edit/page.tsx`

**規劃文檔**
- `claudedocs/1-planning/features/FEAT-005-om-expense-category-management/01-requirements.md`
- `claudedocs/1-planning/features/FEAT-005-om-expense-category-management/02-technical-design.md`
- `claudedocs/1-planning/features/FEAT-005-om-expense-category-management/03-implementation-plan.md`
- `claudedocs/1-planning/features/FEAT-005-om-expense-category-management/04-progress.md`

## Git 提交記錄
```
eadfdf4 fix: 修復 TypeScript 和 ESLint 錯誤
bc762de feat(expense-category): 完成 CHANGE-003 統一費用類別系統
afa9d20 fix(expense): 修復 Expense 編輯功能的多個欄位更新問題
352ea4d feat(expense,chargeout): 完成 CHANGE-002 Phase 3 前端更新
a51a51f docs: 更新 CHANGE-001 和 CHANGE-002 開發記錄與每週進度
5028861 feat(expense,chargeout): 實施 CHANGE-002 費用明細轉嫁目標功能 (Backend)
a97f39f feat(om-expense): 實施 CHANGE-001 來源費用追蹤功能
1c90e1a fix(om-expense-categories): 修復 TypeScript 類型錯誤
b16f16c feat(om-expense-categories): 完成 FEAT-005 OM 費用類別管理功能
```
