# 2025-W49 每週進度 (12月1日 - 12月6日)

## 本週目標
- [x] 完成 FEAT-005: OM Expense Category Management 功能開發
- [x] 完成 CHANGE-001: OMExpense 來源追蹤功能
- [x] 完成 CHANGE-002: ExpenseItem 費用轉嫁目標功能 (Backend + Frontend)
- [ ] 功能測試和驗證
- [ ] 準備下一個功能開發

## 完成情況

### 已完成
- ✅ **FEAT-005: OM Expense Category Management** - OM 費用類別管理完整實現
  - Phase 0: 規劃和需求分析（4 份規劃文檔）
  - Phase 1: 後端開發
    - 新增 `OMExpenseCategory` Prisma Model
    - 修改 `OMExpense` Model 新增 categoryId 關聯
    - 建立 `omExpenseCategory` tRPC Router（完整 CRUD + toggleStatus）
  - Phase 2: 前端開發
    - 建立組件：OMExpenseCategoryForm, OMExpenseCategoryActions
    - 建立頁面：列表、新增、編輯
    - 新增 48 個 I18N 翻譯鍵
  - Phase 3: 整合測試
    - i18n 驗證通過（1954 個鍵）
    - ESLint 問題已修復
    - TypeScript 類型錯誤已修復

- ✅ **CHANGE-001: OMExpense 來源追蹤** (Phase 1+2+3 完成)
  - Phase 1: Schema 修改
    - `OMExpense` 新增 `sourceExpenseId` 欄位
    - `OMExpense` 新增 `sourceExpense` 關聯到 Expense
    - `Expense` 新增 `derivedOMExpenses` 反向關聯
  - Phase 2: API 更新
    - `omExpense.ts` 更新 create/update mutation
    - 新增 `getBySourceExpenseId` 查詢
    - 所有 include 加入 sourceExpense 關聯
  - Phase 3: 前端更新
    - `OMExpenseForm.tsx` 新增來源費用選擇器
    - 新增 sourceExpense 相關翻譯鍵
    - 顯示關聯專案和採購單資訊

- ✅ **CHANGE-002: ExpenseItem 費用轉嫁目標** (Phase 1+2+3 完成 + Bug Fixes)
  - Phase 1: Schema 修改
    - `ExpenseItem` 新增 `chargeOutOpCoId` 欄位
    - `ExpenseItem` 新增 `chargeOutOpCo` 關聯到 OperatingCompany
    - `ChargeOutItem` 新增 `expenseItemId` 欄位
    - `ChargeOutItem.expenseId` 改為可選（向後兼容）
    - `OperatingCompany` 新增 `chargeOutExpenseItems` 反向關聯
  - Phase 2: API 更新
    - `expense.ts` 的 expenseItemSchema 新增 chargeOutOpCoId
    - `chargeOut.ts` 的 chargeOutItemSchema 新增 expenseItemId
    - 更新所有 create/update mutation 處理新欄位
    - 更新 getById/getEligibleExpenses 包含完整關聯
  - Phase 3: 前端更新
    - `ExpenseForm.tsx` 新增 chargeOutOpCoId OpCo 選擇器
    - `ChargeOutForm.tsx` 新增 expenseItemId ExpenseItem 選擇器
    - 新增 chargeOutOpCo 和 expenseItem 相關翻譯鍵
    - TypeScript 錯誤修復
  - **Bug Fixes (12/1)**:
    - 修復 ExpenseForm 編輯模式 defaultValues 載入問題（projectId, vendorId, requiresChargeOut）
    - 修復 updateExpenseSchema 缺少欄位（requiresChargeOut, isOperationMaint, purchaseOrderId, budgetCategoryId）
    - 修復 update mutation handler 未處理這些欄位
    - 新增邏輯：當 requiresChargeOut 從 true 變為 false 時，自動清除所有 ExpenseItem 的 chargeOutOpCoId

- ✅ **i18n 錯誤修復**
  - 修復 ExpenseForm.tsx 的 FORMATTING_ERROR
  - 問題: 翻譯字串期望 `{name}` 參數但使用 `.replace()` 方法
  - 解決: 改用正確的 next-intl 參數語法 `t('key', { name: value })`

- ✅ **UI 組件優化**
  - 擴展 DropdownMenuItem 支援 onClick, asChild, disabled 屬性
  - 修正 Select 組件用法（改用原生 HTML select）
  - 修正 use-toast import 路徑

- ✅ **開發環境設置**
  - Docker 服務啟動（PostgreSQL, Redis, Mailhog, Azurite）
  - Prisma Client 重新生成
  - 資料庫 Schema 同步（db push）

- ✅ **CHANGE-003: 統一費用類別系統** (12/2 完成)
  - Phase 1: Schema 修改
    - 重命名 `OMExpenseCategory` → `ExpenseCategory`（統一命名）
    - `ExpenseItem` 新增 `categoryId` 欄位（FK 到 ExpenseCategory）
  - Phase 2: API 更新
    - 重命名 `omExpenseCategory` Router → `expenseCategory`
    - 更新 `packages/api/src/root.ts` Router 導入
    - 新增 `getActive` 查詢供下拉選單使用
  - Phase 3: 前端更新
    - `ExpenseForm.tsx` 改用動態類別（`api.expenseCategory.getActive`）
    - `OMExpenseForm.tsx` 改用統一 API
    - 更新 om-expense-categories 頁面和組件使用新 API
  - Phase 4: Seed Data
    - 新增 8 個預設費用類別（HW, SW, SV, MAINT, LICENSE, CLOUD, TELECOM, OTHER）
    - 同步更新 `seed.ts` 和 `seed-minimal.ts`
  - Phase 5: 驗證
    - TypeScript 驗證通過（無 CHANGE-003 相關錯誤）
    - 資料庫已成功插入 8 個類別

- ✅ **i18n 修復** (12/2)
  - 新增 `common.actions.openMenu` 翻譯鍵（zh-TW + en）
  - 修復 OMExpenseCategoryActions.tsx IntlError

### 進行中
- （無進行中項目）

### 未開始
- ⏸️ 資料遷移（將舊 category String 轉換為 FK 關係）

## 遇到的挑戰

### 挑戰 1: Prisma generate Windows 檔案鎖定
- **問題**: 開發伺服器運行時無法重新生成 Prisma Client
- **解決方案**: 停止開發伺服器後再執行 `prisma generate`
- **學習**: Windows 環境的檔案鎖定需特別注意

### 挑戰 2: Select 組件 API 不相容
- **問題**: 專案的 Select 組件不支援 Radix UI 的 onValueChange API
- **解決方案**: 改用原生 HTML select 方式（onChange + option）
- **學習**: 使用前先確認組件 API 支援

### 挑戰 3: DropdownMenuItem 缺少屬性
- **問題**: 專案的 DropdownMenuItem 不支援 onClick 和 asChild
- **解決方案**: 擴展組件支援這些屬性
- **學習**: 簡化版 UI 組件可能需要按需擴展

### 挑戰 4: use-toast import 路徑
- **問題**: 錯誤使用 `@/hooks/use-toast`
- **解決方案**: 修正為 `@/components/ui/use-toast`
- **學習**: 注意專案的檔案組織結構

### 挑戰 5: next-intl 參數傳遞
- **問題**: 翻譯字串含參數時使用錯誤的 `.replace()` 方法
- **解決方案**: 使用正確的 next-intl 參數語法 `t('key', { param: value })`
- **學習**: 遵循 next-intl 官方文檔的參數傳遞方式

### 挑戰 6: TypeScript 類型錯誤 - 可選欄位過濾
- **問題**: `chargeOut.ts` 中過濾 expenseId 時產生 `(string | null | undefined)[]` 類型
- **解決方案**: 使用類型守衛 `.filter((id): id is string => id !== null && id !== undefined)`
- **學習**: 可選欄位映射後需要正確的類型過濾

### 挑戰 7: Expense 編輯模式資料載入問題
- **問題**: ExpenseForm 編輯頁面無法正確載入 projectId, vendorId, requiresChargeOut 等欄位
- **原因 1**: Expense model 沒有直接的 projectId 欄位，需從 `purchaseOrder.project.id` 取得
- **原因 2**: 使用 `|| false` 導致 boolean false 值被覆蓋
- **原因 3**: updateExpenseSchema 缺少這些欄位定義
- **解決方案**:
  1. defaultValues 改用正確路徑 (`initialData?.purchaseOrder?.project?.id`)
  2. boolean 欄位改用 `??` nullish coalescing
  3. 補齊 updateExpenseSchema 和 mutation handler 的欄位支援
- **學習**: Prisma 關聯資料的取得路徑需與 model 結構一致

## 技術決策
- **決策 1**: 選擇方案 A - 建立獨立的 OMExpenseCategory Model
  - 選項 A: 獨立 Model + FK 關聯
  - 選項 B: 繼續使用 String category
  - 選擇: A → 更好的資料完整性和可維護性

- **決策 2**: 遷移策略 - 分階段遷移
  - 先新增 categoryId 為可選欄位
  - 後續再移除舊 category String 欄位
  - 理由: 避免破壞現有資料

- **決策 3**: CHANGE-002 ChargeOutItem 向後兼容
  - 新增 expenseItemId 欄位（可選）
  - 保留 expenseId 欄位為可選
  - 理由: 現有資料不受影響，支援漸進式遷移

## 下週計劃
- [ ] 完成 FEAT-005 功能測試
- [ ] 更新 Seed Data 添加預設類別
- [ ] 考慮資料遷移策略
- [ ] 準備下一個功能開發

## 風險提示
- ⚠️ 現有 OMExpense 資料需要遷移（categoryId 目前為 null）
- ⚠️ 現有 ChargeOutItem 資料（expenseItemId 為 null）
- ⚠️ 剩餘 TypeScript 錯誤需處理（azure-storage.ts, exportUtils.ts）

## 統計數據
- **代碼行數**: +2,900 / -200
- **文件變更**: 38+ 個
- **Commits**: 7 次
  - `feat(om-expense-categories): 完成 FEAT-005 OM 費用類別管理功能`
  - `fix(om-expense-categories): 修復 TypeScript 類型錯誤`
  - `feat(om-expense): 實施 CHANGE-001 來源費用追蹤功能`
  - `feat(expense,chargeout): 實施 CHANGE-002 費用明細轉嫁目標功能 (Backend)`
  - `docs: 更新 CHANGE-001 和 CHANGE-002 開發記錄與每週進度`
  - `feat(expense,chargeout): 完成 CHANGE-002 Phase 3 前端更新`
  - `fix(expense): 修復 Expense 編輯功能的多個欄位更新問題`
- **工作時間**: ~8 小時

## 修改的文件

### CHANGE-001 相關
**後端**
- `packages/db/prisma/schema.prisma` - OMExpense 新增 sourceExpenseId, Expense 新增 derivedOMExpenses
- `packages/api/src/routers/omExpense.ts` - 新增 sourceExpenseId 處理

**前端**
- `apps/web/src/components/om-expense/OMExpenseForm.tsx` - 新增來源費用選擇器
- `apps/web/src/components/expense/ExpenseForm.tsx` - 修復 i18n 錯誤
- `apps/web/src/messages/zh-TW.json` - sourceExpense 翻譯
- `apps/web/src/messages/en.json` - sourceExpense 翻譯

**文檔**
- `claudedocs/4-changes/feature-changes/CHANGE-001-omexpense-source-tracking.md`

### CHANGE-002 相關
**後端**
- `packages/db/prisma/schema.prisma` - ExpenseItem 新增 chargeOutOpCoId, ChargeOutItem 新增 expenseItemId
- `packages/api/src/routers/expense.ts` - expenseItemSchema 新增 chargeOutOpCoId
- `packages/api/src/routers/chargeOut.ts` - chargeOutItemSchema 新增 expenseItemId

**前端 (Phase 3)**
- `apps/web/src/components/expense/ExpenseForm.tsx` - 新增 chargeOutOpCoId OpCo 選擇器
- `apps/web/src/components/charge-out/ChargeOutForm.tsx` - 新增 expenseItemId ExpenseItem 選擇器
- `apps/web/src/messages/zh-TW.json` - chargeOutOpCo, expenseItem 翻譯
- `apps/web/src/messages/en.json` - chargeOutOpCo, expenseItem 翻譯

**文檔**
- `claudedocs/4-changes/feature-changes/CHANGE-002-expenseitem-chargeout-target.md`

### FEAT-005 相關（16 個）
**後端**
- `packages/api/src/routers/omExpenseCategory.ts` - tRPC Router

**前端組件**
- `apps/web/src/components/om-expense-category/index.ts`
- `apps/web/src/components/om-expense-category/OMExpenseCategoryForm.tsx`
- `apps/web/src/components/om-expense-category/OMExpenseCategoryActions.tsx`

**前端頁面**
- `apps/web/src/app/[locale]/om-expense-categories/page.tsx`
- `apps/web/src/app/[locale]/om-expense-categories/new/page.tsx`
- `apps/web/src/app/[locale]/om-expense-categories/[id]/edit/page.tsx`

**規劃文檔**
- `claudedocs/1-planning/features/FEAT-005-om-expense-category-management/01-requirements.md`
- `claudedocs/1-planning/features/FEAT-005-om-expense-category-management/02-technical-design.md`
- `claudedocs/1-planning/features/FEAT-005-om-expense-category-management/03-implementation-plan.md`
- `claudedocs/1-planning/features/FEAT-005-om-expense-category-management/04-progress.md`

## Git 提交記錄
```
(pending) fix(expense): 修復 Expense 編輯功能的多個欄位更新問題
352ea4d feat(expense,chargeout): 完成 CHANGE-002 Phase 3 前端更新
a51a51f docs: 更新 CHANGE-001 和 CHANGE-002 開發記錄與每週進度
5028861 feat(expense,chargeout): 實施 CHANGE-002 費用明細轉嫁目標功能 (Backend)
a97f39f feat(om-expense): 實施 CHANGE-001 來源費用追蹤功能
1c90e1a fix(om-expense-categories): 修復 TypeScript 類型錯誤
b16f16c feat(om-expense-categories): 完成 FEAT-005 OM 費用類別管理功能
```
