# 2025-W50 每週進度 (12月9日 - 12月15日)

## 本週目標
- [x] 完成 FEAT-008: OM Expense 資料導入功能規劃
- [x] 實施 FEAT-008 後端 API
- [x] 實施 FEAT-008 前端頁面
- [x] 建立 Excel → JSON 轉換腳本
- [x] 測試導入功能
- [x] 修復 FEAT-008 v1.2 問題（重複檢測 + Transaction 超時）
- [x] 完成 CHANGE-005: OM Expense 批量刪除功能
- [x] 修復 UI 顯示格式問題
- [x] 完成 CHANGE-010: Data Import 日期驗證增強
- [x] 完成 CHANGE-011: OM Expense Item isOngoing 欄位
- [x] 完成 FEAT-009: Operating Company 數據權限管理

## 完成情況

### 已完成

#### 12月9日
- ✅ **FEAT-008: OM Expense 資料導入功能 - 規劃階段完成**
  - 分析導入資料 Excel 檔案結構
    - 500 行資料，69 個 Header，160 個 Item，9 個 Category，42 個 OpCo
  - 完成 4 份功能規劃文檔：
    - 01-requirements.md (需求規格)
    - 02-technical-design.md (技術設計)
    - 03-implementation-plan.md (實施計劃)
    - 04-progress.md (進度追蹤)

#### 12月10日
- ✅ **FEAT-008 v1.0: 基本功能完成**
  - Phase 1: Schema Migration (lastFYActualExpense 欄位)
  - Phase 2: 後端 API 開發 (importData procedure)
  - Phase 3: 前端頁面開發 (/data-import)
  - Phase 4: Excel 客戶端解析 (xlsx/SheetJS)
  - Phase 5: 測試驗證

- ✅ **FEAT-008 v1.1: 改進功能完成**
  - Phase 6: 補充英文翻譯 (60+ 個翻譯鍵)
  - Phase 7: 預覽確認機制 (三步驟流程)

- ✅ **FEAT-008 v1.2: 問題修復完成**
  - Phase 8: 後端重複檢測邏輯修正 (3 欄位 → 6 欄位唯一鍵)
  - Phase 9: 前端註解同步更新
  - Phase 10: Transaction 超時修復 (5 秒 → 5 分鐘)

- ✅ **CHANGE-005: OM Expense 批量刪除功能完成**
  - 後端 deleteMany procedure
  - 前端多選狀態管理 (卡片視圖 + 列表視圖)
  - 批量操作工具列
  - AlertDialog 確認對話框
  - i18n 翻譯鍵 (en + zh-TW)

- ✅ **UI 顯示格式修復**
  - om-summary 頁面 OpCo 選擇項和 Detail List（只顯示名稱）
  - om-expenses/edit 頁面 Expense Category 和 Default OpCo（只顯示名稱）
  - om-expenses 詳情頁 Edit Item 的 OpCo（只顯示名稱）

- ✅ **Azure 公司環境部署 FEAT-008 + CHANGE-005**
  - 部署版本: v23-feat008-import → v24-fix-feat008-column
  - 創建 FEAT-008 資料庫 migration (lastFYActualExpense 欄位)
  - 診斷並修復 500 錯誤 (getSummary + getById APIs)
  - 更新 health.ts fixAllSchemaIssues 添加 FEAT-008 欄位修復

- ✅ **Azure 500 錯誤修復**
  - **問題**: omExpense.getSummary 和 omExpense.getById 返回 500 錯誤
  - **根因**: OMExpenseItem 表缺少 lastFYActualExpense 欄位
  - **修復**: 更新 fixAllSchemaIssues API 添加缺失欄位
  - **驗證**: 所有頁面返回 200 OK

#### 12月11日
- ✅ **CHANGE-010: Data Import 日期驗證增強**
  - endDate 空值檢查和錯誤處理
  - endDate 格式驗證和錯誤處理
  - lastFYActualExpense 前端默認值改為 0
  - currencyId 默認為 USD
  - **修正**: EXCEL_COLUMN_MAP lastFYActualExpense 欄位映射 (Column N → Column K)

- ✅ **CHANGE-011: OM Expense Item isOngoing 欄位**
  - 新增 OMExpenseItem.isOngoing 欄位 (持續進行中標記)
  - 前端 Checkbox UI 和條件式驗證
  - Data import 邏輯: 空 endDate → isOngoing=true
  - updateItem API 支援 isOngoing 處理
  - **Bug 修復**:
    1. isOngoing 保存無效 → 修復 updateItem procedure
    2. Date 對象格式解析錯誤 → 新增 instanceof Date 處理
    3. isOngoing 未傳遞到 API → 新增 mutation payload 欄位
    4. lastFYActualExpense 欄位映射錯誤 → 修正 index

- ✅ **Git Commits (12/11)**
  - `9ff6d8c` - feat(om-expense): CHANGE-011 新增 isOngoing 持續進行中欄位
  - `b349192` - fix(om-expense): CHANGE-011 修復 isOngoing 保存和清空 endDate
  - `9506345` - fix(data-import): 修復 Date 對象格式的日期解析
  - `2fec107` - fix(data-import): CHANGE-011 修復 isOngoing 和 lastFYActualExpense 傳遞
  - `c401f51` - fix(data-import): 修正 EXCEL_COLUMN_MAP lastFYActualExpense 欄位映射

#### 12月14日
- ✅ **CHANGE-013: 專案導入 Charge Out OpCos 欄位解析修復**
  - 修改 OpCo 匹配邏輯：優先使用 company name 匹配（大小寫不敏感）
  - 備用使用 company code 匹配（大小寫不敏感）
  - 建立 opCoNameMap (主要) 和 opCoCodeMap (備用) 兩個映射表
  - 更新無效 OpCo 提示從 code 改為 name

- ✅ **CHANGE-014: OM Summary OpCo 權限過濾**
  - 新增 `filterChargeOutMethodByPermission` 函數
  - ProjectSummaryTable 新增 props: `userOpCoCodes`, `isAdmin`
  - 根據用戶 OpCo 權限過濾 Charge Out Method 欄位顯示
  - Admin 用戶可查看全部數據
  - 無權限時顯示 "無權限" 提示
  - 新增 i18n 翻譯 `projectSummary.table.noAccess`
  - **Bug 修復 (第二次)**:
    1. 問題：即使 Admin 登入仍看不到全部數據
    2. 根因：資料庫 Role 表 ID 映射與程式碼預期不一致
       - 資料庫: id=1→Admin, id=2→ProjectManager, id=3→Supervisor
       - 程式碼預期: id=1→PM, id=2→Supervisor, id=3→Admin
    3. 修復：改用 `role.name === 'Admin'` 判斷（與 trpc.ts adminProcedure 一致）
    4. 影響檔案: auth/index.ts, operatingCompany.ts, om-summary/page.tsx

- ✅ **en.json 翻譯修復 (60+ 處)**
  - 修復 `auth.forgotPassword` 區段 (5 項)
  - 修復 `projects.list` 區段 (12 項)
  - 修復 `projects.form.create/edit` 區段 (4 項)
  - 修復 `proposals.list` 區段 (12 項)
  - 修復 `proposals.form` 區段 (14 項)
  - 修復 `budgetPools.list` 區段 (16 項)
  - 修復 `budgetPools.detail` 區段 (2 項)
  - 修復 `budgetPools.form` 區段 (18 項)
  - 修復 `notifications.list` 區段 (3 項)
  - 修復 `notifications.types` 區段 (6 項)
  - 修復 `settings.sections` 區段 (4 項)
  - 修復 `validation` 區段 (15 項)
  - 通過 `pnpm validate:i18n` 驗證

#### 12月12日
- ✅ **FEAT-009: Operating Company 數據權限管理**
  - **Phase 1: 數據模型**
    - 新增 UserOperatingCompany 多對多關係表 (schema.prisma)
    - User 和 OperatingCompany 模型新增關聯欄位
    - 執行 `prisma generate` 和 `prisma db push`
  - **Phase 2: 後端 API (operatingCompany.ts)**
    - `getUserPermissions` - Supervisor 專用，獲取用戶 OpCo 權限
    - `setUserPermissions` - Supervisor 專用，設定用戶權限 (Transaction)
    - `getForCurrentUser` - Protected，根據用戶權限過濾 OpCo
    - Admin (roleId >= 3) 自動獲得所有 OpCo
    - 向後兼容：無權限記錄的用戶可看到所有 OpCo
  - **Phase 3: 前端權限管理 UI**
    - 新增 `OpCoPermissionSelector` 組件 (多選 Checkbox)
    - 用戶編輯頁面新增 OpCo 權限設定 Card
    - i18n 翻譯 (en.json + zh-TW.json) `users.permissions.*`
    - 全選/清除功能，自動儲存
  - **Phase 4: OM Summary 整合**
    - 修改 `operatingCompany.getAll` → `getForCurrentUser`
    - OpCo 下拉選單自動根據用戶權限過濾
  - **Bug 修復 (P-002)**
    - 問題：權限保存後不持久化，重進頁面無變化
    - 原因：mutation 未 invalidate getUserPermissions 查詢緩存
    - 修復：`utils.operatingCompany.getUserPermissions.invalidate({ userId })`

### 進行中
- 無

### 未開始
- ⏸️ **FEAT-006: Project Summary Tab** - 規劃完成，待開發

## 遇到的挑戰

### 挑戰 1: 部分記錄導入後消失
- **問題**: Excel Row 34 和 Row 35 有相同的 Header + ItemName + OpCo，但有不同的 Description 和 Budget。前端使用 6 欄位唯一鍵，後端只用 3 欄位，導致前端通過的記錄在後端被跳過。
- **解決方案**: 修改後端重複檢測為 6 欄位完整唯一鍵（headerName, itemName, itemDescription, category, opCoName, budgetAmount）
- **學習**: 前後端的重複檢測邏輯必須保持一致

### 挑戰 2: Transaction 超時
- **問題**: Prisma Transaction 預設超時 5 秒，導入 387 筆資料時超時
- **解決方案**: 增加 transaction 超時設定（maxWait: 10s, timeout: 300s）
- **學習**: 大量資料操作需要適當調整 transaction 設定

## 技術決策

### 決策 1: 重複檢測唯一鍵
- **選項 A**: 3 欄位（Header + ItemName + OpCo）
- **選項 B**: 6 欄位（Header + ItemName + Description + Category + OpCo + Budget）
- **選擇**: B → 確保相同組合但不同描述/預算的記錄可以共存

### 決策 2: Transaction 超時時間
- **選項 A**: 預設 5 秒
- **選項 B**: 5 分鐘
- **選擇**: B → 足夠導入 500+ 筆資料，保留餘裕

### 決策 3: OpCo/Category 顯示格式
- **選項 A**: Code - Name（如 `RIT - R.IT`）
- **選項 B**: 只顯示 Name
- **選擇**: B → 使用者只需看名稱，Code 是內部識別

## 下週計劃
- [x] Azure 部署 FEAT-008 + CHANGE-005 ✅ 已完成
- [ ] 使用實際資料測試導入功能
- [ ] 開始 FEAT-006: Project Summary Tab 開發

## 風險提示
- ⚠️ 導入 500+ 筆資料已測試可行（5 分鐘超時足夠）
- ⚠️ OpCo 命名不一致問題（如 `R.IT` vs `RIT`）需後續人工處理

## 統計數據
- **代碼行數**: +2800 (預估，含 FEAT-009, CHANGE-013, CHANGE-014)
- **文件變更**: 30+ 個
- **Commits**: 10+ (FEAT-008, CHANGE-005, Azure 修復, CHANGE-010, CHANGE-011, FEAT-009, FEAT-010, CHANGE-012, CHANGE-013, CHANGE-014)
- **工作時間**: ~15 小時
- **Azure 部署版本**: v24-fix-feat008-column

## 文件變更清單

### 新增文件
| 文件 | 說明 |
|------|------|
| `apps/web/src/app/[locale]/data-import/page.tsx` | Data Import 頁面 |
| `scripts/convert-excel-to-import-json.py` | Excel 轉 JSON 腳本 |
| `scripts/extract-screenshot-data.py` | 截圖資料提取腳本 |
| `claudedocs/1-planning/features/FEAT-008-om-expense-data-import/05-enhancements.md` | v1.1 改進需求 |
| `claudedocs/4-changes/feature-changes/CHANGE-005-om-expense-batch-delete.md` | 批量刪除規劃 |
| `docs/om-expense-rhk-extracted.json` | 提取的導入資料 |
| `docs/om-expense-screenshot-extracted.json` | 截圖提取資料 |
| `docs/test-import-data.json` | 測試導入資料 |

### 修改文件
| 文件 | 說明 |
|------|------|
| `packages/db/prisma/schema.prisma` | OMExpenseItem 新增 lastFYActualExpense 欄位 |
| `packages/api/src/routers/omExpense.ts` | importData + deleteMany procedures + 6 欄位唯一鍵 |
| `packages/api/src/routers/health.ts` | fixAllSchemaIssues 添加 FEAT-008 欄位修復 |
| `packages/db/prisma/migrations/20251210100000_feat008_lastfy_actual_expense/migration.sql` | FEAT-008 migration |
| `apps/web/src/app/[locale]/om-expenses/page.tsx` | 批量刪除 UI |
| `apps/web/src/components/layout/Sidebar.tsx` | Data Import 導航 |
| `apps/web/src/components/om-summary/OMSummaryFilters.tsx` | OpCo 顯示格式修復 |
| `apps/web/src/components/om-summary/OMSummaryDetailGrid.tsx` | OpCo 顯示格式修復 |
| `apps/web/src/components/om-expense/OMExpenseForm.tsx` | Category/OpCo 顯示格式修復 |
| `apps/web/src/components/om-expense/OMExpenseItemForm.tsx` | OpCo 顯示格式修復 |
| `apps/web/src/messages/en.json` | dataImport + batchDelete 翻譯 |
| `apps/web/src/messages/zh-TW.json` | dataImport + batchDelete 翻譯 |
| `apps/web/package.json` | 新增 xlsx 依賴 |

| `claudedocs/4-changes/feature-changes/CHANGE-010-data-import-enhancements.md` | Data Import 日期驗證增強規劃 |
| `claudedocs/4-changes/feature-changes/CHANGE-011-om-expense-item-ongoing-field.md` | isOngoing 欄位規劃 |
| `apps/web/src/components/user/OpCoPermissionSelector.tsx` | FEAT-009 OpCo 權限選擇器組件 |
| `claudedocs/1-planning/features/FEAT-009-opco-data-permission/01-requirements.md` | FEAT-009 需求規格 |
| `claudedocs/1-planning/features/FEAT-009-opco-data-permission/02-technical-design.md` | FEAT-009 技術設計 |
| `claudedocs/1-planning/features/FEAT-009-opco-data-permission/03-implementation-plan.md` | FEAT-009 實施計劃 |
| `claudedocs/1-planning/features/FEAT-009-opco-data-permission/04-progress.md` | FEAT-009 進度追蹤 |

### FEAT-009 修改文件
| 文件 | 說明 |
|------|------|
| `packages/db/prisma/schema.prisma` | 新增 UserOperatingCompany model |
| `packages/api/src/routers/operatingCompany.ts` | 新增 getUserPermissions, setUserPermissions, getForCurrentUser |
| `apps/web/src/app/[locale]/users/[id]/edit/page.tsx` | 新增 OpCo 權限設定區塊 |
| `apps/web/src/app/[locale]/om-summary/page.tsx` | 改用 getForCurrentUser API |
| `apps/web/src/messages/en.json` | 新增 users.permissions.* 翻譯 |
| `apps/web/src/messages/zh-TW.json` | 新增 users.permissions.* 翻譯 |

---

**維護者**: AI 助手 + 開發團隊
**最後更新**: 2025-12-14
