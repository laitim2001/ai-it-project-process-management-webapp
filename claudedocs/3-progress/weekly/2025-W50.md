# 2025-W50 每週進度 (12月9日 - 12月15日)

## 本週目標
- [x] 完成 FEAT-008: OM Expense 資料導入功能規劃
- [x] 實施 FEAT-008 後端 API
- [x] 實施 FEAT-008 前端頁面
- [x] 建立 Excel → JSON 轉換腳本
- [x] 測試導入功能
- [x] 修復 FEAT-008 v1.2 問題（重複檢測 + Transaction 超時）
- [x] 完成 CHANGE-005: OM Expense 批量刪除功能
- [x] 修復 UI 顯示格式問題
- [x] 完成 CHANGE-010: Data Import 日期驗證增強
- [x] 完成 CHANGE-011: OM Expense Item isOngoing 欄位
- [x] 完成 FEAT-009: Operating Company 數據權限管理

## 完成情況

### 已完成

#### 12月9日
- ✅ **FEAT-008: OM Expense 資料導入功能 - 規劃階段完成**
  - 分析導入資料 Excel 檔案結構
    - 500 行資料，69 個 Header，160 個 Item，9 個 Category，42 個 OpCo
  - 完成 4 份功能規劃文檔：
    - 01-requirements.md (需求規格)
    - 02-technical-design.md (技術設計)
    - 03-implementation-plan.md (實施計劃)
    - 04-progress.md (進度追蹤)

#### 12月10日
- ✅ **FEAT-008 v1.0: 基本功能完成**
  - Phase 1: Schema Migration (lastFYActualExpense 欄位)
  - Phase 2: 後端 API 開發 (importData procedure)
  - Phase 3: 前端頁面開發 (/data-import)
  - Phase 4: Excel 客戶端解析 (xlsx/SheetJS)
  - Phase 5: 測試驗證

- ✅ **FEAT-008 v1.1: 改進功能完成**
  - Phase 6: 補充英文翻譯 (60+ 個翻譯鍵)
  - Phase 7: 預覽確認機制 (三步驟流程)

- ✅ **FEAT-008 v1.2: 問題修復完成**
  - Phase 8: 後端重複檢測邏輯修正 (3 欄位 → 6 欄位唯一鍵)
  - Phase 9: 前端註解同步更新
  - Phase 10: Transaction 超時修復 (5 秒 → 5 分鐘)

- ✅ **CHANGE-005: OM Expense 批量刪除功能完成**
  - 後端 deleteMany procedure
  - 前端多選狀態管理 (卡片視圖 + 列表視圖)
  - 批量操作工具列
  - AlertDialog 確認對話框
  - i18n 翻譯鍵 (en + zh-TW)

- ✅ **UI 顯示格式修復**
  - om-summary 頁面 OpCo 選擇項和 Detail List（只顯示名稱）
  - om-expenses/edit 頁面 Expense Category 和 Default OpCo（只顯示名稱）
  - om-expenses 詳情頁 Edit Item 的 OpCo（只顯示名稱）

- ✅ **Azure 公司環境部署 FEAT-008 + CHANGE-005**
  - 部署版本: v23-feat008-import → v24-fix-feat008-column
  - 創建 FEAT-008 資料庫 migration (lastFYActualExpense 欄位)
  - 診斷並修復 500 錯誤 (getSummary + getById APIs)
  - 更新 health.ts fixAllSchemaIssues 添加 FEAT-008 欄位修復

- ✅ **Azure 500 錯誤修復**
  - **問題**: omExpense.getSummary 和 omExpense.getById 返回 500 錯誤
  - **根因**: OMExpenseItem 表缺少 lastFYActualExpense 欄位
  - **修復**: 更新 fixAllSchemaIssues API 添加缺失欄位
  - **驗證**: 所有頁面返回 200 OK

#### 12月11日
- ✅ **CHANGE-010: Data Import 日期驗證增強**
  - endDate 空值檢查和錯誤處理
  - endDate 格式驗證和錯誤處理
  - lastFYActualExpense 前端默認值改為 0
  - currencyId 默認為 USD
  - **修正**: EXCEL_COLUMN_MAP lastFYActualExpense 欄位映射 (Column N → Column K)

- ✅ **CHANGE-011: OM Expense Item isOngoing 欄位**
  - 新增 OMExpenseItem.isOngoing 欄位 (持續進行中標記)
  - 前端 Checkbox UI 和條件式驗證
  - Data import 邏輯: 空 endDate → isOngoing=true
  - updateItem API 支援 isOngoing 處理
  - **Bug 修復**:
    1. isOngoing 保存無效 → 修復 updateItem procedure
    2. Date 對象格式解析錯誤 → 新增 instanceof Date 處理
    3. isOngoing 未傳遞到 API → 新增 mutation payload 欄位
    4. lastFYActualExpense 欄位映射錯誤 → 修正 index

- ✅ **Git Commits (12/11)**
  - `9ff6d8c` - feat(om-expense): CHANGE-011 新增 isOngoing 持續進行中欄位
  - `b349192` - fix(om-expense): CHANGE-011 修復 isOngoing 保存和清空 endDate
  - `9506345` - fix(data-import): 修復 Date 對象格式的日期解析
  - `2fec107` - fix(data-import): CHANGE-011 修復 isOngoing 和 lastFYActualExpense 傳遞
  - `c401f51` - fix(data-import): 修正 EXCEL_COLUMN_MAP lastFYActualExpense 欄位映射

#### 12月14日
- ✅ **CHANGE-013: 專案導入 Charge Out OpCos 欄位解析修復**
  - 修改 OpCo 匹配邏輯：優先使用 company name 匹配（大小寫不敏感）
  - 備用使用 company code 匹配（大小寫不敏感）
  - 建立 opCoNameMap (主要) 和 opCoCodeMap (備用) 兩個映射表
  - 更新無效 OpCo 提示從 code 改為 name

- ✅ **CHANGE-014: OM Summary OpCo 權限過濾**
  - 新增 `filterChargeOutMethodByPermission` 函數
  - ProjectSummaryTable 新增 props: `userOpCoCodes`, `isAdmin`
  - 根據用戶 OpCo 權限過濾 Charge Out Method 欄位顯示
  - Admin 用戶可查看全部數據
  - 無權限時顯示 "無權限" 提示
  - 新增 i18n 翻譯 `projectSummary.table.noAccess`
  - **Bug 修復 (第二次)**:
    1. 問題：即使 Admin 登入仍看不到全部數據
    2. 根因：資料庫 Role 表 ID 映射與程式碼預期不一致
       - 資料庫: id=1→Admin, id=2→ProjectManager, id=3→Supervisor
       - 程式碼預期: id=1→PM, id=2→Supervisor, id=3→Admin
    3. 修復：改用 `role.name === 'Admin'` 判斷（與 trpc.ts adminProcedure 一致）
    4. 影響檔案: auth/index.ts, operatingCompany.ts, om-summary/page.tsx

- ✅ **en.json 翻譯修復 (60+ 處)**
  - 修復 `auth.forgotPassword` 區段 (5 項)
  - 修復 `projects.list` 區段 (12 項)
  - 修復 `projects.form.create/edit` 區段 (4 項)
  - 修復 `proposals.list` 區段 (12 項)
  - 修復 `proposals.form` 區段 (14 項)
  - 修復 `budgetPools.list` 區段 (16 項)
  - 修復 `budgetPools.detail` 區段 (2 項)
  - 修復 `budgetPools.form` 區段 (18 項)
  - 修復 `notifications.list` 區段 (3 項)
  - 修復 `notifications.types` 區段 (6 項)
  - 修復 `settings.sections` 區段 (4 項)
  - 修復 `validation` 區段 (15 項)
  - 通過 `pnpm validate:i18n` 驗證

- ✅ **CHANGE-015: Dashboard 通用登陸頁面**
  - Dashboard 作為登入後預設首頁（不需要 menu:dashboard 權限）
  - 快速操作面板根據用戶菜單權限過濾顯示
  - 新增 `dashboard.quickActions.noActions` i18n 翻譯鍵
  - 使用 `usePermissions` hook 進行權限檢查
  - **Commit**: `5a30dec`

- ✅ **CHANGE-016: Dashboard 簡化版專業歡迎頁面**
  - 移除所有敏感數據顯示（統計、圖表、活動列表等）
  - 採用方案 C 極簡專業風格（居中卡片佈局）
  - 顯示：系統名稱、歡迎訊息、用戶角色、格式化日期、導航提示
  - 備份完整版為 `page-full-version.tsx.bak`
  - 新增 `dashboard.welcome.*` i18n 翻譯鍵結構
  - **Commit**: `49d6359`

- ✅ **FEAT-011: Permission Management (Sidebar 菜單權限) - Phase 1 完成**
  - **Phase 1.1: 數據模型**
    - 新增 Permission model (權限表，含 code/name/category)
    - 新增 RolePermission model (角色預設權限)
    - 新增 UserPermission model (用戶自訂權限覆蓋)
  - **Phase 1.2: 種子數據**
    - 18 個菜單權限 (menu:dashboard, menu:projects, etc.)
    - 3 個角色預設權限配置 (Admin: 全部, Supervisor: 17 個, PM: 8 個)
  - **Phase 1.3: 後端 API (permission.ts router)**
    - `getMyPermissions` - 獲取當前用戶有效權限
    - `getUserPermissions` - Admin 專用，獲取特定用戶權限
    - `setUserPermissions` - Admin 專用，設定用戶權限覆蓋
  - **Phase 1.4: 前端 Hook (usePermissions.ts)**
    - `hasPermission()` - 單一權限檢查
    - `hasAnyPermission()` - 任一權限檢查
    - `hasAllPermissions()` - 全部權限檢查
    - MENU_PERMISSIONS 常量 (18 個權限代碼)
  - **Phase 1.5: Sidebar 改造**
    - 所有導航項目添加 permissionCode
    - 權限過濾邏輯
    - 載入狀態 (Skeleton UI)
  - **Phase 1.6: 用戶管理 UI**
    - UserPermissionsConfig 組件 (權限配置)
    - 整合到用戶詳情頁 (僅 Admin 可見)
    - i18n 翻譯 (users.permissions.*)
  - **Phase 1.7: 路由保護**
    - PermissionGate 組件 (客戶端路由保護)
    - 支援單一/任一/全部權限檢查
    - 拒絕訪問頁面和重定向功能
  - **Phase 1.8: 測試驗證**
    - i18n 驗證通過 (2388 個鍵)
    - TypeScript 檢查通過 (FEAT-011 相關檔案)

#### 12月15日
- ✅ **CHANGE-017: Budget Proposal Delete Enhancement**
  - 單一刪除和批量刪除功能 (僅 Draft 狀態可刪除)
  - 權限檢查：僅建立者（專案經理）或 Admin 可刪除
  - 前端 AlertDialog 確認對話框
  - i18n 翻譯 (en + zh-TW)
  - **Bug 修復**: Foreign Key 約束錯誤 - 使用 Transaction 先刪除 History/Comment 再刪除提案

- ✅ **CHANGE-018: Budget Proposal Status Revert Function**
  - 回退到草稿功能 (PendingApproval/Approved/Rejected/MoreInfoRequired → Draft)
  - 權限：僅 Admin 或 Supervisor 可執行
  - 必填回退原因輸入
  - AlertDialog 確認對話框
  - History 記錄追蹤 (action: "REVERTED_TO_DRAFT")
  - i18n 翻譯 (en + zh-TW)
  - **Bug 修復**:
    1. `toast.cancel` → `tCommon('actions.cancel')`
    2. History.create 缺少 `user: { connect: { id } }`
    3. History.create 缺少 `budgetProposal: { connect: { id } }`
    4. Delete Dialog 翻譯錯誤 `tCommon('actions.confirmDelete')` → `t('actions.delete')`

- ✅ **CHANGE-019: Project Delete Enhancement**
  - 單一刪除和批量刪除功能
  - 權限檢查：僅建立者或 Admin 可刪除
  - 預設禁止刪除有關聯資料的專案（hasRelatedData 檢查）
  - 可選強制刪除模式（Cascade Delete 關聯的 Proposals, POs, Expenses 等）
  - 前端 AlertDialog 確認對話框（普通/強制刪除不同提示）
  - i18n 翻譯 (en + zh-TW)
  - **Database Cleanup**: 刪除 55 個測試專案及關聯資料（保留 OM Expenses）

- ✅ **CHANGE-020: Data Import FY Auto-Detection**
  - 從 Excel Column A 自動讀取財務年度 (FY)
  - 支援多種 FY 格式：`2026`, `FY26`, `FY2026`, `FY 26`, `26`
  - 自動偵測最常見的 FY 值並預設選取
  - 預覽頁面顯示偵測結果（成功/失敗提示）
  - 手動覆寫選項
  - 更新 Excel 欄位說明表（Column A = FY）
  - i18n 翻譯 (en + zh-TW): `detectedFY.*`, `excelFormat.fields/desc.financialYear`

- ✅ **Database Cleanup (12/15)**
  - 刪除 2 個無法訪問的預算池：`bp-2025-it`, `bp-2024-it`
  - 系統剩餘預算池：`Budget pool 2026 (FY2026)`

- ✅ **CHANGE-021 ~ CHANGE-024: Delete Enhancement 系列 (12/15)**
  - **CHANGE-021: Quote Delete Enhancement**
    - 後端 API: quote.delete (狀態檢查)、quote.deleteMany (批量刪除)
    - 前端 UI: Checkbox 多選、批量操作工具列、AlertDialog 確認
    - i18n 翻譯 (en + zh-TW)
  - **CHANGE-022: Purchase Order Delete Enhancement**
    - 後端 API: 修改 delete (Expense 關聯檢查)、deleteMany (批量)、revertToDraft (退回草稿)
    - 前端 UI: 同上 + 退回草稿功能
    - 刪除限制：僅 Draft 可刪，有 Expense 關聯不可刪
  - **CHANGE-023: Expense Delete Enhancement**
    - 後端 API: 修改 delete (ChargeOut 關聯檢查)、deleteMany、revertToDraft
    - 前端 UI: 同上 + 退回草稿功能
    - 刪除限制：僅 Draft 可刪，有 ChargeOutItem 關聯不可刪
  - **CHANGE-024: Charge Out Delete Enhancement**
    - 後端 API: deleteMany、revertToDraft
    - 前端 UI: 同上 + 退回草稿功能
    - 刪除限制：僅 Draft/Rejected 可刪
  - **i18n 修復**: expenses.dialogs.delete.cannotDeleteDescription 翻譯錯誤
    - 問題：en.json 使用 `{reason}` 變量但代碼未提供
    - 修復：移除變量，使翻譯與 zh-TW.json 一致

- ✅ **CHANGE-026: Expense 狀態回退預算回沖修復（階段 1）**
  - **問題**: `revertToDraft` API 從 Approved/Paid 退回時未回沖預算
  - **影響**: BudgetPool.usedAmount 和 BudgetCategory.usedAmount 數據不正確
  - **修復文件**: `packages/api/src/routers/expense.ts` (行 740-828)
  - **修復內容**:
    - 添加預算回沖邏輯：從 Approved/Paid 退回時回沖 BudgetPool.usedAmount
    - 添加 BudgetCategory.usedAmount 回沖支援
    - 使用事務確保數據一致性
    - 添加 Math.max(0, ...) 防止 usedAmount 變負數
  - **文檔**: `claudedocs/1-planning/features/CHANGE-026-EXPENSE-STATUS-REVERT-BUDGET-FIX.md`

- ✅ **CHANGE-025: Purchase Order 狀態回退增強 (Approved → Submitted)**
  - **功能**: 新增 `revertToSubmitted` API 讓已批准的 PO 可退回已提交狀態
  - **後端**:
    - 新增 `purchaseOrder.revertToSubmitted` API (行 631-675)
    - 使用 `supervisorProcedure` 確保僅 Supervisor 可執行
    - 僅 Approved 狀態可退回 Submitted
    - 清除 `approvedDate`
  - **前端**:
    - 新增 `canRevertToSubmitted` 輔助函數
    - 卡片視圖和列表視圖添加「退回已提交」選項
    - 新增確認對話框 `revertToSubmittedDialogOpen`
  - **i18n**:
    - zh-TW: `purchaseOrders.actions.revertToSubmitted`, `messages.revertToSubmittedSuccess/Error`, `dialogs.revertToSubmitted.*`
    - en: 對應英文翻譯
  - **文檔**: `claudedocs/1-planning/features/CHANGE-025-PO-STATUS-REVERT-ENHANCEMENT.md`

- ✅ **FIX-008: 專案狀態卡在 InProgress 無法回退修復**
  - **問題**: 刪除預算提案後，專案狀態會卡在 InProgress，無法退回 Draft 或刪除
  - **根因**: 當預算提案被批准時專案狀態改為 InProgress，但當提案被回退或刪除時專案狀態未同步回退
  - **修復**:
    1. `budgetProposal.revertToDraft` 自動檢查並回退專案狀態（當最後一個已批准提案被回退時）
    2. 新增 `project.revertToDraft` API 手動回退專案狀態
    3. 前端專案詳情頁新增「退回草稿」按鈕 (Manager/Supervisor/Admin 可操作)
  - **修改文件**:
    - `packages/api/src/routers/budgetProposal.ts` - 新增專案狀態自動回退邏輯
    - `packages/api/src/routers/project.ts` - 新增 revertToDraft API
    - `apps/web/src/app/[locale]/projects/[id]/page.tsx` - 新增退回草稿按鈕 UI
    - `apps/web/src/messages/en.json`, `zh-TW.json` - 新增 i18n 翻譯

- ✅ **FIX-009: ProjectSummaryTable 欄位顯示不完整修復**
  - **問題**: OM Summary > Project Summary List 中 Project Name 和 Description 無法顯示完整內容
  - **根因**: 使用 `truncate` CSS class 截斷文字，且欄位寬度只有 18%
  - **修復**:
    1. 調整欄位寬度百分比（Project Name 從 18% 增加到 25%）
    2. 移除 `truncate` CSS class，改用 `break-words` 允許文字換行
    3. Description 使用 `line-clamp-2` 限制最多 2 行
  - **修改文件**:
    - `apps/web/src/components/project-summary/ProjectSummaryTable.tsx`

- ✅ **完整 Schema 同步機制**
  - **問題根源分析**: 本地使用 `db:push` 直接同步，Azure 使用 `migrate deploy` 只執行 migration 文件
  - **migrations 不完整**: FEAT-001/006/010 欄位缺失、Permission 表缺失
  - **解決方案**: 設計 Health API 完整 Schema 同步機制
  - **核心文件**:
    - `packages/api/src/lib/schemaDefinition.ts` - 唯一真相來源 (27 個表格定義)
    - `packages/api/src/routers/health.ts` - 新增 fullSchemaCompare + fullSchemaSync API
  - **新增 API**:
    - `health.fullSchemaCompare` (GET) - 完整對比所有 27 個表格
    - `health.fullSchemaSync` (POST) - 一鍵修復所有差異 (9 個 Phase)
  - **修復範圍**:
    - Phase 1: 創建缺失表格 (Permission, RolePermission, UserPermission, ProjectChargeOutOpCo, UserOperatingCompany)
    - Phase 2: 修復 Project 表 (FEAT-001/006/010 共 19 欄位)
    - Phase 3: 修復 PurchaseOrder 表 (date, currencyId, approvedDate)
    - Phase 4: 修復 BudgetPool 表 (isActive, description, currencyId)
    - Phase 5: 修復 Expense 表 (7 欄位)
    - Phase 6: 修復 ExpenseItem 表 (categoryId, chargeOutOpCoId)
    - Phase 7: 修復 OMExpense 表 (FEAT-007 共 6 欄位)
    - Phase 8: 修復 OMExpenseItem 表 (lastFYActualExpense, isOngoing)
    - Phase 9: 創建必要索引
  - **文檔更新**:
    - 新增 `claudedocs/SCHEMA-SYNC-MECHANISM.md` - 機制說明文檔
    - 更新 `claudedocs/COMPANY-AZURE-DEPLOYMENT-LOG.md` - 部署日誌
    - 更新 `SITUATION-7-AZURE-DEPLOY-COMPANY.md` v2.2.0 - 部署指南

#### 12月12日
- ✅ **FEAT-009: Operating Company 數據權限管理**
  - **Phase 1: 數據模型**
    - 新增 UserOperatingCompany 多對多關係表 (schema.prisma)
    - User 和 OperatingCompany 模型新增關聯欄位
    - 執行 `prisma generate` 和 `prisma db push`
  - **Phase 2: 後端 API (operatingCompany.ts)**
    - `getUserPermissions` - Supervisor 專用，獲取用戶 OpCo 權限
    - `setUserPermissions` - Supervisor 專用，設定用戶權限 (Transaction)
    - `getForCurrentUser` - Protected，根據用戶權限過濾 OpCo
    - Admin (roleId >= 3) 自動獲得所有 OpCo
    - 向後兼容：無權限記錄的用戶可看到所有 OpCo
  - **Phase 3: 前端權限管理 UI**
    - 新增 `OpCoPermissionSelector` 組件 (多選 Checkbox)
    - 用戶編輯頁面新增 OpCo 權限設定 Card
    - i18n 翻譯 (en.json + zh-TW.json) `users.permissions.*`
    - 全選/清除功能，自動儲存
  - **Phase 4: OM Summary 整合**
    - 修改 `operatingCompany.getAll` → `getForCurrentUser`
    - OpCo 下拉選單自動根據用戶權限過濾
  - **Bug 修復 (P-002)**
    - 問題：權限保存後不持久化，重進頁面無變化
    - 原因：mutation 未 invalidate getUserPermissions 查詢緩存
    - 修復：`utils.operatingCompany.getUserPermissions.invalidate({ userId })`

### 進行中
- 無

### 未開始
- ⏸️ **FEAT-006: Project Summary Tab** - 規劃完成，待開發

## 遇到的挑戰

### 挑戰 1: 部分記錄導入後消失
- **問題**: Excel Row 34 和 Row 35 有相同的 Header + ItemName + OpCo，但有不同的 Description 和 Budget。前端使用 6 欄位唯一鍵，後端只用 3 欄位，導致前端通過的記錄在後端被跳過。
- **解決方案**: 修改後端重複檢測為 6 欄位完整唯一鍵（headerName, itemName, itemDescription, category, opCoName, budgetAmount）
- **學習**: 前後端的重複檢測邏輯必須保持一致

### 挑戰 2: Transaction 超時
- **問題**: Prisma Transaction 預設超時 5 秒，導入 387 筆資料時超時
- **解決方案**: 增加 transaction 超時設定（maxWait: 10s, timeout: 300s）
- **學習**: 大量資料操作需要適當調整 transaction 設定

## 技術決策

### 決策 1: 重複檢測唯一鍵
- **選項 A**: 3 欄位（Header + ItemName + OpCo）
- **選項 B**: 6 欄位（Header + ItemName + Description + Category + OpCo + Budget）
- **選擇**: B → 確保相同組合但不同描述/預算的記錄可以共存

### 決策 2: Transaction 超時時間
- **選項 A**: 預設 5 秒
- **選項 B**: 5 分鐘
- **選擇**: B → 足夠導入 500+ 筆資料，保留餘裕

### 決策 3: OpCo/Category 顯示格式
- **選項 A**: Code - Name（如 `RIT - R.IT`）
- **選項 B**: 只顯示 Name
- **選擇**: B → 使用者只需看名稱，Code 是內部識別

## 下週計劃
- [x] Azure 部署 FEAT-008 + CHANGE-005 ✅ 已完成
- [ ] 使用實際資料測試導入功能
- [ ] 開始 FEAT-006: Project Summary Tab 開發

## 風險提示
- ⚠️ 導入 500+ 筆資料已測試可行（5 分鐘超時足夠）
- ⚠️ OpCo 命名不一致問題（如 `R.IT` vs `RIT`）需後續人工處理

## 統計數據
- **代碼行數**: +5000 (預估，含 FEAT-009, FEAT-011, CHANGE-013~020, Schema 同步機制)
- **文件變更**: 60+ 個
- **Commits**: 25+ (FEAT-008, CHANGE-005, Azure 修復, CHANGE-010~020, FEAT-009~011, Schema 同步)
- **i18n 翻譯鍵**: 2434 個
- **工作時間**: ~28 小時
- **Azure 部署版本**: v29-fix-date (最新成功部署)
- **新增重要文件**:
  - `packages/api/src/lib/schemaDefinition.ts` - 唯一真相來源 (約 400 行)
  - `claudedocs/SCHEMA-SYNC-MECHANISM.md` - 機制說明文檔
  - `claudedocs/4-changes/feature-changes/CHANGE-019-project-delete-enhancement.md` - Project 刪除增強

## 文件變更清單

### 新增文件
| 文件 | 說明 |
|------|------|
| `apps/web/src/app/[locale]/data-import/page.tsx` | Data Import 頁面 |
| `scripts/convert-excel-to-import-json.py` | Excel 轉 JSON 腳本 |
| `scripts/extract-screenshot-data.py` | 截圖資料提取腳本 |
| `claudedocs/1-planning/features/FEAT-008-om-expense-data-import/05-enhancements.md` | v1.1 改進需求 |
| `claudedocs/4-changes/feature-changes/CHANGE-005-om-expense-batch-delete.md` | 批量刪除規劃 |
| `docs/om-expense-rhk-extracted.json` | 提取的導入資料 |
| `docs/om-expense-screenshot-extracted.json` | 截圖提取資料 |
| `docs/test-import-data.json` | 測試導入資料 |

### 修改文件
| 文件 | 說明 |
|------|------|
| `packages/db/prisma/schema.prisma` | OMExpenseItem 新增 lastFYActualExpense 欄位 |
| `packages/api/src/routers/omExpense.ts` | importData + deleteMany procedures + 6 欄位唯一鍵 |
| `packages/api/src/routers/health.ts` | fixAllSchemaIssues 添加 FEAT-008 欄位修復 |
| `packages/db/prisma/migrations/20251210100000_feat008_lastfy_actual_expense/migration.sql` | FEAT-008 migration |
| `apps/web/src/app/[locale]/om-expenses/page.tsx` | 批量刪除 UI |
| `apps/web/src/components/layout/Sidebar.tsx` | Data Import 導航 |
| `apps/web/src/components/om-summary/OMSummaryFilters.tsx` | OpCo 顯示格式修復 |
| `apps/web/src/components/om-summary/OMSummaryDetailGrid.tsx` | OpCo 顯示格式修復 |
| `apps/web/src/components/om-expense/OMExpenseForm.tsx` | Category/OpCo 顯示格式修復 |
| `apps/web/src/components/om-expense/OMExpenseItemForm.tsx` | OpCo 顯示格式修復 |
| `apps/web/src/messages/en.json` | dataImport + batchDelete 翻譯 |
| `apps/web/src/messages/zh-TW.json` | dataImport + batchDelete 翻譯 |
| `apps/web/package.json` | 新增 xlsx 依賴 |

| `claudedocs/4-changes/feature-changes/CHANGE-010-data-import-enhancements.md` | Data Import 日期驗證增強規劃 |
| `claudedocs/4-changes/feature-changes/CHANGE-011-om-expense-item-ongoing-field.md` | isOngoing 欄位規劃 |
| `apps/web/src/components/user/OpCoPermissionSelector.tsx` | FEAT-009 OpCo 權限選擇器組件 |
| `claudedocs/1-planning/features/FEAT-009-opco-data-permission/01-requirements.md` | FEAT-009 需求規格 |
| `claudedocs/1-planning/features/FEAT-009-opco-data-permission/02-technical-design.md` | FEAT-009 技術設計 |
| `claudedocs/1-planning/features/FEAT-009-opco-data-permission/03-implementation-plan.md` | FEAT-009 實施計劃 |
| `claudedocs/1-planning/features/FEAT-009-opco-data-permission/04-progress.md` | FEAT-009 進度追蹤 |

### FEAT-009 修改文件
| 文件 | 說明 |
|------|------|
| `packages/db/prisma/schema.prisma` | 新增 UserOperatingCompany model |
| `packages/api/src/routers/operatingCompany.ts` | 新增 getUserPermissions, setUserPermissions, getForCurrentUser |
| `apps/web/src/app/[locale]/users/[id]/edit/page.tsx` | 新增 OpCo 權限設定區塊 |
| `apps/web/src/app/[locale]/om-summary/page.tsx` | 改用 getForCurrentUser API |
| `apps/web/src/messages/en.json` | 新增 users.permissions.* 翻譯 |
| `apps/web/src/messages/zh-TW.json` | 新增 users.permissions.* 翻譯 |

### FEAT-011 新增/修改文件
| 文件 | 說明 |
|------|------|
| `packages/db/prisma/schema.prisma` | 新增 Permission, RolePermission, UserPermission models |
| `packages/db/prisma/seed.ts` | 新增 18 個菜單權限種子數據 |
| `packages/api/src/routers/permission.ts` | 新增權限管理 API Router |
| `packages/api/src/root.ts` | 註冊 permissionRouter |
| `apps/web/src/hooks/usePermissions.ts` | 新增權限管理 Hook |
| `apps/web/src/components/layout/Sidebar.tsx` | 添加權限過濾功能 |
| `apps/web/src/components/layout/PermissionGate.tsx` | 新增路由保護組件 |
| `apps/web/src/components/user/UserPermissionsConfig.tsx` | 新增權限配置 UI 組件 |
| `apps/web/src/app/[locale]/users/[id]/page.tsx` | 整合權限配置區段 |
| `apps/web/src/hooks/CLAUDE.md` | 更新 usePermissions 文檔 |
| `apps/web/src/components/layout/CLAUDE.md` | 更新 PermissionGate 文檔 |
| `apps/web/src/messages/en.json` | 新增 common.errors.*, users.permissions.* 翻譯 |
| `apps/web/src/messages/zh-TW.json` | 新增 common.errors.*, users.permissions.* 翻譯 |
| `claudedocs/1-planning/features/FEAT-011-permission-management/01-requirements.md` | 需求規格 |
| `claudedocs/1-planning/features/FEAT-011-permission-management/02-technical-design.md` | 技術設計 |
| `claudedocs/1-planning/features/FEAT-011-permission-management/03-implementation-plan.md` | 實施計劃 |

### CHANGE-015 & CHANGE-016 修改文件
| 文件 | 說明 |
|------|------|
| `apps/web/src/app/[locale]/dashboard/page.tsx` | CHANGE-015 權限過濾 → CHANGE-016 簡化版歡迎頁面 |
| `apps/web/src/app/[locale]/dashboard/page-full-version.tsx.bak` | 完整版 Dashboard 備份 |
| `apps/web/src/messages/en.json` | 新增 dashboard.welcome.*, dashboard.quickActions.noActions |
| `apps/web/src/messages/zh-TW.json` | 新增 dashboard.welcome.*, dashboard.quickActions.noActions |
| `claudedocs/4-changes/feature-changes/CHANGE-015-dashboard-universal-landing-page.md` | CHANGE-015 文檔 |
| `claudedocs/4-changes/feature-changes/CHANGE-016-dashboard-simplified-version.md` | CHANGE-016 文檔 |

### CHANGE-019 & CHANGE-020 修改文件
| 文件 | 說明 |
|------|------|
| `packages/api/src/routers/project.ts` | 新增 delete, deleteMany procedures (Cascade Delete) |
| `apps/web/src/app/[locale]/projects/page.tsx` | 新增批量刪除 UI、強制刪除確認對話框 |
| `apps/web/src/app/[locale]/projects/[id]/page.tsx` | 新增單一刪除功能、強制刪除選項 |
| `apps/web/src/app/[locale]/data-import/page.tsx` | CHANGE-020: FY 自動偵測、Column A 解析 |
| `apps/web/src/messages/en.json` | 新增 projects.actions.delete/forceDelete/*, dataImport.detectedFY.* |
| `apps/web/src/messages/zh-TW.json` | 新增 projects.actions.delete/forceDelete/*, dataImport.detectedFY.* |
| `claudedocs/4-changes/feature-changes/CHANGE-019-project-delete-enhancement.md` | CHANGE-019 文檔 |

---

**維護者**: AI 助手 + 開發團隊
**最後更新**: 2025-12-15
