# Epic 6: 費用記錄與審批 - 功能測試清單

**測試日期**: 2025-10-05
**測試環境**: Development (localhost:3001)
**資料庫**: PostgreSQL (localhost:5434/itpm_dev)

## 測試範圍

- ✅ 費用列表頁面 (`/expenses`)
- ✅ 費用詳情頁面 (`/expenses/[id]`)
- ✅ 新增費用頁面 (`/expenses/new`)
- ✅ 編輯費用頁面 (`/expenses/[id]/edit`)
- ✅ 費用表單組件 (ExpenseForm)
- ✅ 發票上傳功能 (`/api/upload/invoice`)
- ✅ 採購單頁面費用整合 (`/purchase-orders/[id]`)

---

## 1. 費用列表頁面測試

### UI 顯示
- [ ] 頁面正常載入
- [ ] 麵包屑導航顯示正確
- [ ] 「新增費用」按鈕存在且可點擊
- [ ] 統計卡片顯示正確數據:
  - [ ] 總費用記錄數量
  - [ ] 總金額 (TWD)
  - [ ] 待審批數量
  - [ ] 已支付數量

### 篩選功能
- [ ] 狀態篩選下拉選單正常運作:
  - [ ] 所有狀態 (預設)
  - [ ] 草稿
  - [ ] 待審批
  - [ ] 已批准
  - [ ] 已支付
- [ ] 採購單篩選下拉選單正常運作
- [ ] 篩選後頁碼重置為第 1 頁
- [ ] 結果計數顯示正確範圍

### 列表顯示
- [ ] 費用卡片正確顯示:
  - [ ] 費用金額
  - [ ] 狀態徽章 (Draft/PendingApproval/Approved/Paid)
  - [ ] 費用日期
  - [ ] 採購單編號
  - [ ] 專案名稱
  - [ ] 發票文件名稱 (如有)
- [ ] 點擊卡片能正確導航至詳情頁面
- [ ] 空狀態顯示「尚無費用記錄」提示

### 分頁功能
- [ ] 分頁組件在超過 10 筆記錄時顯示
- [ ] 頁碼切換正常運作
- [ ] 每頁顯示最多 10 筆記錄

**測試結果**: ⏳ 待測試

---

## 2. 費用詳情頁面測試

### UI 顯示
- [ ] 頁面正常載入
- [ ] 麵包屑導航包含費用編號
- [ ] 費用資訊卡片顯示:
  - [ ] 費用金額
  - [ ] 費用日期
  - [ ] 狀態徽章
  - [ ] 創建日期
  - [ ] 最後更新日期
- [ ] 發票資訊卡片顯示:
  - [ ] 發票文件下載連結 (如有)
  - [ ] 發票文件預覽 (如為圖片)
  - [ ] 無發票時顯示「尚未上傳發票」
- [ ] 關聯資訊卡片顯示:
  - [ ] 採購單連結
  - [ ] 專案連結
  - [ ] 供應商連結

### 權限控制
- [ ] 草稿狀態:
  - [ ] 顯示「編輯」按鈕
  - [ ] 顯示「刪除」按鈕
  - [ ] 顯示「提交審批」按鈕
- [ ] 待審批狀態:
  - [ ] 顯示「批准」按鈕
  - [ ] 顯示「拒絕」按鈕
  - [ ] 隱藏編輯/刪除按鈕
- [ ] 已批准狀態:
  - [ ] 顯示「標記為已支付」按鈕
  - [ ] 隱藏其他操作按鈕
- [ ] 已支付狀態:
  - [ ] 隱藏所有操作按鈕
  - [ ] 顯示「已完成」狀態說明

### 操作功能
- [ ] **提交審批** (Draft → PendingApproval):
  - [ ] 按鈕點擊後狀態更新
  - [ ] Toast 通知顯示成功訊息
  - [ ] 頁面自動刷新顯示新狀態
  - [ ] 操作按鈕根據新狀態更新

- [ ] **批准** (PendingApproval → Approved):
  - [ ] 顯示預算扣款警告確認對話框
  - [ ] 確認後狀態更新為「已批准」
  - [ ] 預算池 usedAmount 正確增加
  - [ ] 預算不足時顯示錯誤訊息
  - [ ] Toast 通知顯示成功訊息

- [ ] **拒絕** (PendingApproval → Draft):
  - [ ] 顯示拒絕原因輸入對話框
  - [ ] 未輸入原因時顯示錯誤提示
  - [ ] 輸入原因後成功拒絕
  - [ ] 狀態返回「草稿」
  - [ ] Toast 通知顯示成功訊息

- [ ] **標記為已支付** (Approved → Paid):
  - [ ] 顯示確認對話框
  - [ ] 確認後狀態更新為「已支付」
  - [ ] Toast 通知顯示成功訊息

- [ ] **編輯**:
  - [ ] 僅草稿狀態可編輯
  - [ ] 點擊後導航至編輯頁面

- [ ] **刪除**:
  - [ ] 僅草稿狀態可刪除
  - [ ] 顯示確認對話框
  - [ ] 確認後成功刪除並返回列表頁

### 狀態說明側邊欄
- [ ] 根據當前狀態顯示正確說明:
  - [ ] 草稿: 可編輯、提交審批
  - [ ] 待審批: 可批准或拒絕
  - [ ] 已批准: 可標記為已支付
  - [ ] 已支付: 流程完成

**測試結果**: ⏳ 待測試

---

## 3. 新增費用頁面測試

### UI 顯示
- [ ] 頁面正常載入
- [ ] 麵包屑導航正確
- [ ] 頁面標題「新增費用」
- [ ] ExpenseForm 組件正確渲染

### URL 參數
- [ ] 從採購單頁面導航時 `?purchaseOrderId=xxx`:
  - [ ] 採購單下拉選單自動選中該採購單
  - [ ] 其他欄位為空
- [ ] 直接訪問 `/expenses/new`:
  - [ ] 所有欄位為空

### 表單提交
- [ ] 參考「費用表單組件測試」

**測試結果**: ⏳ 待測試

---

## 4. 編輯費用頁面測試

### UI 顯示
- [ ] 頁面正常載入
- [ ] 麵包屑導航包含「編輯」
- [ ] 頁面標題「編輯費用」
- [ ] ExpenseForm 組件正確渲染

### 數據載入
- [ ] 自動載入現有費用數據:
  - [ ] 採購單選中正確值 (且禁用編輯)
  - [ ] 費用金額顯示正確值
  - [ ] 費用日期顯示正確值
  - [ ] 現有發票文件連結顯示 (如有)

### 表單提交
- [ ] 參考「費用表單組件測試」

**測試結果**: ⏳ 待測試

---

## 5. 費用表單組件測試

### 基本輸入驗證
- [ ] **採購單選擇**:
  - [ ] 下拉選單載入所有可用採購單
  - [ ] 顯示格式: `PO號 - 專案名稱 ($金額)`
  - [ ] 必填欄位 (未選擇時顯示錯誤)
  - [ ] 編輯模式下禁用選擇

- [ ] **費用金額**:
  - [ ] 輸入框接受數字
  - [ ] 支援小數點 (兩位)
  - [ ] 必填欄位 (未填寫時顯示錯誤)
  - [ ] 負數或零時顯示錯誤

- [ ] **費用日期**:
  - [ ] 日期選擇器正常運作
  - [ ] 預設為今日日期 (新增模式)
  - [ ] 必填欄位

### 發票上傳功能
- [ ] **文件選擇**:
  - [ ] 點擊「選擇文件」按鈕打開文件選擇器
  - [ ] 僅接受指定格式 (.pdf, .doc, .docx, .xls, .xlsx, .jpg, .jpeg, .png)
  - [ ] 選擇文件後顯示文件名稱
  - [ ] 文件圖示顯示

- [ ] **文件驗證**:
  - [ ] 不支援的文件類型顯示錯誤 Toast
  - [ ] 文件大小超過 10MB 顯示錯誤 Toast
  - [ ] 驗證失敗時不保存文件選擇

- [ ] **現有發票顯示** (編輯模式):
  - [ ] 顯示「當前發票」連結
  - [ ] 點擊連結可下載或預覽
  - [ ] 選擇新文件後隱藏舊連結

### 表單提交流程
- [ ] **新增費用流程**:
  1. [ ] 填寫所有必填欄位
  2. [ ] 選擇發票文件 (可選)
  3. [ ] 點擊「創建費用」
  4. [ ] 如有文件:
     - [ ] 先上傳發票至 `/api/upload/invoice`
     - [ ] 上傳成功後取得 filePath
     - [ ] 將 filePath 包含在費用創建請求中
  5. [ ] 調用 `expense.create` mutation
  6. [ ] 成功後顯示 Toast 並導航至費用詳情頁
  7. [ ] 失敗時顯示錯誤 Toast

- [ ] **更新費用流程**:
  1. [ ] 修改欄位值
  2. [ ] (可選) 選擇新發票文件
  3. [ ] 點擊「更新費用」
  4. [ ] 如有新文件先上傳
  5. [ ] 調用 `expense.update` mutation
  6. [ ] 成功後導航至費用詳情頁

- [ ] **取消操作**:
  - [ ] 點擊「取消」按鈕返回上一頁
  - [ ] 未保存的更改丟失 (符合預期)

### 提示訊息
- [ ] 顯示費用記錄須知卡片:
  - [ ] 費用金額不應超過採購單總金額
  - [ ] 建議上傳發票文件以便審核
  - [ ] 保存後可提交審批

### 載入狀態
- [ ] 提交中顯示:
  - [ ] 按鈕文字變為「處理中...」
  - [ ] 按鈕禁用
  - [ ] 旋轉的上傳圖示
- [ ] 所有輸入欄位在提交中禁用

**測試結果**: ⏳ 待測試

---

## 6. 發票上傳 API 測試

### API 端點: `POST /api/upload/invoice`

#### 請求驗證
- [ ] **FormData 結構**:
  - [ ] `file`: File 對象 (必填)
  - [ ] `purchaseOrderId`: string (必填)

- [ ] **文件類型驗證**:
  - [ ] PDF: `application/pdf` ✅
  - [ ] Word: `application/vnd.openxmlformats-officedocument.wordprocessingml.document`, `application/msword` ✅
  - [ ] Excel: `application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`, `application/vnd.ms-excel` ✅
  - [ ] 圖片: `image/jpeg`, `image/jpg`, `image/png` ✅
  - [ ] 其他類型: 返回 400 錯誤 ❌

- [ ] **文件大小驗證**:
  - [ ] <= 10MB: 通過 ✅
  - [ ] > 10MB: 返回 400 錯誤 ❌

#### 文件存儲
- [ ] 文件保存位置: `public/uploads/invoices/`
- [ ] 文件命名格式: `invoice_{purchaseOrderId}_{timestamp}.{ext}`
- [ ] 目錄不存在時自動創建
- [ ] 文件成功寫入磁碟

#### 響應格式
- [ ] **成功 (200)**:
  ```json
  {
    "success": true,
    "filePath": "/uploads/invoices/invoice_xxx_yyy.pdf"
  }
  ```

- [ ] **失敗 (400/500)**:
  ```json
  {
    "error": "錯誤訊息"
  }
  ```

#### 錯誤處理
- [ ] 缺少必填欄位: 400 錯誤
- [ ] 文件類型不支援: 400 錯誤
- [ ] 文件大小超過限制: 400 錯誤
- [ ] 文件寫入失敗: 500 錯誤

**測試結果**: ⏳ 待測試

---

## 7. 採購單頁面費用整合測試

### 頁面: `/purchase-orders/[id]`

#### 費用記錄區塊
- [ ] 「費用記錄」卡片存在
- [ ] 卡片標題旁有「新增費用」按鈕
- [ ] 點擊「新增費用」導航至 `/expenses/new?purchaseOrderId={id}`

#### 費用列表顯示
- [ ] 有費用記錄時:
  - [ ] 每筆費用顯示為卡片
  - [ ] 卡片包含: 金額、狀態徽章、費用日期、發票文件名
  - [ ] 點擊卡片導航至費用詳情頁
  - [ ] 費用統計摘要顯示:
    - [ ] 總費用記錄筆數
    - [ ] 累計金額

- [ ] 無費用記錄時:
  - [ ] 顯示「尚無費用記錄」提示
  - [ ] 顯示「新增第一筆費用」按鈕
  - [ ] 點擊按鈕導航至新增費用頁面

#### 狀態徽章
- [ ] Draft: 灰色「草稿」徽章
- [ ] PendingApproval: 橙色「待審批」徽章
- [ ] Approved: 綠色「已批准」徽章
- [ ] Paid: 藍色「已支付」徽章

**測試結果**: ⏳ 待測試

---

## 8. 端到端工作流程測試

### 工作流程: 從創建到支付

#### 步驟 1: 創建費用 (Draft)
1. [ ] 訪問 `/purchase-orders/{po_id}`
2. [ ] 點擊「新增費用」
3. [ ] 採購單自動選中
4. [ ] 填寫費用金額: $200,000
5. [ ] 選擇費用日期: 今日
6. [ ] 上傳發票文件 (PDF)
7. [ ] 點擊「創建費用」
8. [ ] 驗證:
   - [ ] Toast 顯示「費用已成功創建!」
   - [ ] 導航至費用詳情頁
   - [ ] 狀態為「草稿」
   - [ ] 發票文件連結存在

#### 步驟 2: 編輯費用 (Draft)
1. [ ] 點擊「編輯」按鈕
2. [ ] 修改費用金額為 $250,000
3. [ ] 更換發票文件
4. [ ] 點擊「更新費用」
5. [ ] 驗證:
   - [ ] Toast 顯示「費用已成功更新!」
   - [ ] 返回詳情頁
   - [ ] 金額顯示 $250,000
   - [ ] 新發票文件連結顯示

#### 步驟 3: 提交審批 (Draft → PendingApproval)
1. [ ] 點擊「提交審批」按鈕
2. [ ] 驗證:
   - [ ] Toast 顯示「費用已成功提交審批!」
   - [ ] 狀態變為「待審批」
   - [ ] 「編輯」和「刪除」按鈕消失
   - [ ] 「批准」和「拒絕」按鈕出現

#### 步驟 4: 批准費用 (PendingApproval → Approved)
1. [ ] 點擊「批准」按鈕
2. [ ] 確認對話框顯示預算扣款警告
3. [ ] 點擊確認
4. [ ] 驗證:
   - [ ] Toast 顯示「費用已成功批准!」
   - [ ] 狀態變為「已批准」
   - [ ] 查詢預算池:
     ```sql
     SELECT usedAmount FROM BudgetPool WHERE id = '{budget_pool_id}';
     ```
     usedAmount 應增加 $250,000

#### 步驟 5: 標記為已支付 (Approved → Paid)
1. [ ] 點擊「標記為已支付」按鈕
2. [ ] 確認對話框
3. [ ] 點擊確認
4. [ ] 驗證:
   - [ ] Toast 顯示「費用已成功標記為已支付!」
   - [ ] 狀態變為「已支付」
   - [ ] 所有操作按鈕消失

#### 步驟 6: 驗證採購單頁面
1. [ ] 返回採購單詳情頁
2. [ ] 驗證:
   - [ ] 費用列表包含新創建的費用
   - [ ] 狀態徽章顯示「已支付」
   - [ ] 累計金額正確計算

**測試結果**: ⏳ 待測試

---

### 工作流程: 拒絕並重新提交

#### 步驟 1: 創建並提交費用
1. [ ] 創建新費用 $150,000
2. [ ] 提交審批

#### 步驟 2: 拒絕費用 (PendingApproval → Draft)
1. [ ] 點擊「拒絕」按鈕
2. [ ] 對話框中輸入拒絕原因: "金額需重新核算"
3. [ ] 點擊確認
4. [ ] 驗證:
   - [ ] Toast 顯示「費用已拒絕」
   - [ ] 狀態返回「草稿」
   - [ ] 「編輯」和「刪除」按鈕重新出現

#### 步驟 3: 修正並重新提交
1. [ ] 點擊「編輯」
2. [ ] 修改金額為 $120,000
3. [ ] 保存
4. [ ] 提交審批
5. [ ] 批准
6. [ ] 標記為已支付
7. [ ] 驗證完整流程成功

**測試結果**: ⏳ 待測試

---

## 9. 預算池扣款測試

### 測試場景: 正常扣款
1. [ ] 查詢當前預算池:
   ```sql
   SELECT id, totalAmount, usedAmount
   FROM BudgetPool
   WHERE fiscalYear = 2024;
   ```
   記錄 `usedAmount` 初始值

2. [ ] 創建費用 $100,000
3. [ ] 提交並批准
4. [ ] 再次查詢預算池
5. [ ] 驗證:
   - [ ] `usedAmount` = 初始值 + $100,000

### 測試場景: 預算不足
1. [ ] 查詢當前預算池:
   ```sql
   SELECT totalAmount, usedAmount
   FROM BudgetPool
   WHERE fiscalYear = 2024;
   ```
   計算剩餘預算: `totalAmount - usedAmount`

2. [ ] 創建費用金額 > 剩餘預算
3. [ ] 提交並嘗試批准
4. [ ] 驗證:
   - [ ] Toast 顯示錯誤: "預算池餘額不足"
   - [ ] 費用狀態保持「待審批」
   - [ ] 預算池 `usedAmount` 未變動

### 測試場景: 多筆費用累計扣款
1. [ ] 創建 3 筆費用:
   - 費用 1: $50,000
   - 費用 2: $70,000
   - 費用 3: $30,000
2. [ ] 逐一提交並批准
3. [ ] 驗證:
   - [ ] 預算池 `usedAmount` 累計增加 $150,000
   - [ ] 每次批准都正確扣款

**測試結果**: ⏳ 待測試

---

## 10. API 錯誤處理測試

### expense.create
- [ ] 缺少 purchaseOrderId: 顯示錯誤
- [ ] 缺少 amount: 顯示錯誤
- [ ] 缺少 expenseDate: 顯示錯誤
- [ ] amount <= 0: 顯示錯誤
- [ ] purchaseOrderId 不存在: 顯示錯誤

### expense.update
- [ ] 費用不存在: 顯示錯誤
- [ ] 無權限更新: 顯示錯誤

### expense.submit
- [ ] 費用狀態不是 Draft: 顯示錯誤「只有草稿狀態的費用才能提交」

### expense.approve
- [ ] 費用狀態不是 PendingApproval: 顯示錯誤
- [ ] 預算不足: 顯示錯誤「預算池餘額不足」

### expense.reject
- [ ] 費用狀態不是 PendingApproval: 顯示錯誤
- [ ] 缺少拒絕原因: 顯示錯誤

### expense.markAsPaid
- [ ] 費用狀態不是 Approved: 顯示錯誤「只有已批准狀態的費用才能標記為已支付」

**測試結果**: ⏳ 待測試

---

## 11. 性能測試

### 頁面載入速度
- [ ] 費用列表頁: < 2 秒 (100 筆記錄)
- [ ] 費用詳情頁: < 1 秒
- [ ] 新增/編輯頁面: < 1 秒

### API 響應時間
- [ ] expense.getAll: < 500ms
- [ ] expense.getById: < 200ms
- [ ] expense.create: < 1 秒 (含文件上傳)
- [ ] expense.approve: < 500ms (含預算扣款)

### 文件上傳
- [ ] 1MB PDF: < 2 秒
- [ ] 5MB 圖片: < 5 秒
- [ ] 10MB Excel: < 10 秒

**測試結果**: ⏳ 待測試

---

## 12. 用戶體驗測試

### 導航流程
- [ ] 從採購單頁面新增費用流程順暢
- [ ] 費用詳情頁返回按鈕正確運作
- [ ] 麵包屑導航在所有頁面正確顯示

### 錯誤訊息
- [ ] Toast 通知清晰易懂
- [ ] 錯誤訊息提供足夠資訊
- [ ] 成功訊息鼓勵且明確

### 視覺設計
- [ ] 狀態徽章顏色區分明確
- [ ] 表單佈局清晰易讀
- [ ] 按鈕大小適中易點擊
- [ ] 卡片間距合理

### 響應式設計
- [ ] 桌面版 (1920x1080): 完美顯示
- [ ] 平板版 (768x1024): 佈局適配
- [ ] 手機版 (375x667): 單欄顯示

**測試結果**: ⏳ 待測試

---

## 測試總結

### 功能完成度
- ✅ **費用 CRUD**: 100% 完成
- ✅ **審批工作流程**: 100% 完成 (Draft → PendingApproval → Approved → Paid)
- ✅ **發票上傳**: 100% 完成
- ✅ **預算池扣款**: 100% 完成
- ✅ **採購單整合**: 100% 完成
- ✅ **權限控制**: 100% 完成

### 已知問題
*(測試後填寫)*

### 改進建議
*(測試後填寫)*

### 下一步
1. [ ] 執行完整測試清單
2. [ ] 修復發現的問題
3. [ ] 更新 DEVELOPMENT-LOG.md
4. [ ] 準備 Epic 7 開發

---

**文檔版本**: 1.0
**最後更新**: 2025-10-05
**更新者**: Claude Code
